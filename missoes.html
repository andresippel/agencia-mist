<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumo de Missões - Agência MIST</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* CSS Final para a coluna Ações */
        thead th:last-child,
        tbody td:last-child {
            width: 50px;
            text-align: center;
        }
        .actions-cell {
            padding: 5px 0;
        }
        .actions-cell button {
            display: block;
            margin: 0 auto;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .actions-cell button:first-child {
            margin-bottom: 5px;
        }
        .edit-btn { background-color: #f39c12; }
        .edit-btn:hover { background-color: #e67e22; }
        .delete-btn { background-color: #e74c3c; }
        .delete-btn:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Resumo de Missões</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>
        
        <table>
            <thead>
                <tr>
                    <th>Missão</th>
                    <th>Data</th>
                    <th>Recompensa</th>
                    <th>Agência</th>
                    <th>Akane</th>
                    <th>Gemini</th>
                    <th>Tilas</th>
                    <th>Daemian</th>
                    <th>Bart</th>
                    <th>Resumo</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="missions-table-body"></tbody>
        </table>

        <div class="form-container">
            <h3 id="form-title">Adicionar Nova Missão</h3>
            <form id="mission-form">
                <input type="hidden" id="mission-id">
                <div class="form-group"><label for="mission-name">Nome da Missão</label><input type="text" id="mission-name" required></div>
                <div class="form-group"><label for="mission-date">Data</label><input type="text" id="mission-date" placeholder="dd/mm/aaaa" required></div>
                <div class="form-group"><label for="mission-reward">Recompensa Total</label><input type="number" id="mission-reward" value="0"></div>
                <div class="form-group"><label for="mission-agency">Agência</label><input type="number" id="mission-agency" value="0"></div>
                <div class="form-group"><label for="mission-akane">Akane</label><input type="number" id="mission-akane" value="0"></div>
                <div class="form-group"><label for="mission-gemini">Gemini</label><input type="number" id="mission-gemini" value="0"></div>
                <div class="form-group"><label for="mission-tilas">Tilas</label><input type="number" id="mission-tilas" value="0"></div>
                <div class="form-group"><label for="mission-daemian">Daemian</label><input type="number" id="mission-daemian" value="0"></div>
                <div class="form-group"><label for="mission-bart">Bart</label><input type="number" id="mission-bart" value="0"></div>
                <div class="form-group"><label for="mission-summary">Resumo</label><textarea id="mission-summary" rows="3"></textarea></div>
                <button type="submit" id="submit-btn">Adicionar Missão</button>
                <button type="button" id="cancel-btn" style="display:none;">Cancelar Edição</button>
            </form>
        </div>
    </div>

    <script>
        // --- Conexões com o Firebase ---
        const db = firebase.firestore();
        const missionsCollection = db.collection("missions");
        const financesCollection = db.collection("finances"); // Conexão com a coleção de finanças

        // --- Referências aos elementos do formulário ---
        const form = document.getElementById('mission-form');
        const tableBody = document.getElementById('missions-table-body');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        // --- Funções Auxiliares ---
        const resetForm = () => { form.reset(); form['mission-id'].value = ''; formTitle.textContent = 'Adicionar Nova Missão'; submitBtn.textContent = 'Adicionar Missão'; cancelBtn.style.display = 'none'; };
        
        // Função para converter data de "dd/mm/yyyy" para um objeto de Data do JS
        const parseDateString = (dateStr) => {
            if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                console.warn("Formato de data inválido. Usando a data atual como fallback.");
                return new Date();
            }
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        };
        
        // --- LÓGICA PRINCIPAL DE AUTOMAÇÃO ---

        /**
         * Salva a missão e sincroniza os lançamentos financeiros.
         * @param {string|null} missionId - ID da missão se estiver editando.
         * @param {object} missionData - Dados da missão vindos do formulário.
         */
        const saveMissionAndSyncFinances = async (missionId, missionData) => {
            try {
                // 1. Salva os dados na coleção 'missions'
                const missionRef = missionId ? missionsCollection.doc(missionId) : missionsCollection.doc();
                await missionRef.set({ ...missionData, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                const newMissionId = missionRef.id;

                // 2. Apaga os lançamentos financeiros antigos associados a esta missão
                const oldEntriesQuery = await financesCollection.where("missionId", "==", newMissionId).get();
                if (!oldEntriesQuery.empty) {
                    const batch = db.batch();
                    oldEntriesQuery.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }

                // 3. Cria os novos lançamentos financeiros
                const creationPromises = [];
                const missionDate = parseDateString(missionData.date);
                const missionTimestamp = firebase.firestore.Timestamp.fromDate(missionDate);

                // Lançamentos para os personagens
                const characterRewards = missionData.characterRewards || {};
                for (const charName in characterRewards) {
                    const amount = Number(characterRewards[charName]);
                    if (amount > 0) {
                        creationPromises.push(financesCollection.add({
                            character: charName, amount,
                            description: `Recompensa: ${missionData.name}`,
                            createdAt: missionTimestamp,
                            missionId: newMissionId
                        }));
                    }
                }

                // Lançamento para a Agência
                const agencyCut = Number(missionData.agency);
                if (agencyCut > 0) {
                    creationPromises.push(financesCollection.add({
                        character: "Agência", amount: agencyCut,
                        description: `Taxa da Agência: ${missionData.name}`,
                        createdAt: missionTimestamp,
                        missionId: newMissionId
                    }));
                }

                await Promise.all(creationPromises);
                alert("Missão salva e finanças sincronizadas com sucesso!");

            } catch (error) {
                console.error("Erro ao salvar e sincronizar:", error);
                alert("Ocorreu um erro. Verifique o console.");
            }
        };

        /**
         * Exclui uma missão E os lançamentos financeiros associados a ela.
         * @param {string} missionId - O ID da missão a ser excluída.
         */
        const deleteMissionAndFinances = async (missionId) => {
            if (!confirm("Tem certeza que deseja excluir esta missão? Todos os lançamentos financeiros associados a ela também serão apagados.")) {
                return;
            }
            try {
                // 1. Apaga os lançamentos financeiros associados
                const oldEntriesQuery = await financesCollection.where("missionId", "==", missionId).get();
                if (!oldEntriesQuery.empty) {
                    const batch = db.batch();
                    oldEntriesQuery.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }

                // 2. Apaga a missão
                await missionsCollection.doc(missionId).delete();
                alert("Missão e lançamentos financeiros excluídos com sucesso.");

            } catch (error) {
                console.error("Erro ao excluir missão:", error);
                alert("Ocorreu um erro ao excluir a missão.");
            }
        };
        
        // --- Event Listeners e Renderização ---

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const missionId = form['mission-id'].value || null;
            
            const missionData = {
                name: form['mission-name'].value,
                date: form['mission-date'].value,
                reward: Number(form['mission-reward'].value),
                agency: Number(form['mission-agency'].value),
                summary: form['mission-summary'].value,
                characterRewards: { // Objeto para facilitar a iteração
                    Akane: Number(form['mission-akane'].value),
                    Gemini: Number(form['mission-gemini'].value),
                    Tilas: Number(form['mission-tilas'].value),
                    Daemian: Number(form['mission-daemian'].value),
                    Bart: Number(form['mission-bart'].value)
                }
            };
            
            await saveMissionAndSyncFinances(missionId, missionData);
            resetForm();
        });
        
        const editMission = (id, data) => {
            form['mission-id'].value = id;
            form['mission-name'].value = data.name;
            form['mission-date'].value = data.date;
            form['mission-reward'].value = data.reward;
            form['mission-agency'].value = data.agency;
            form['mission-summary'].value = data.summary;
            form['mission-akane'].value = data.characterRewards.Akane || 0;
            form['mission-gemini'].value = data.characterRewards.Gemini || 0;
            form['mission-tilas'].value = data.characterRewards.Tilas || 0;
            form['mission-daemian'].value = data.characterRewards.Daemian || 0;
            form['mission-bart'].value = data.characterRewards.Bart || 0;
            
            formTitle.textContent = 'Editando Missão';
            submitBtn.textContent = 'Salvar Alterações';
            cancelBtn.style.display = 'inline-block';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };
        
        cancelBtn.addEventListener('click', resetForm);

        missionsCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
            tableBody.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const mission = doc.data();
                const missionId = doc.id;
                const rewards = mission.characterRewards || {}; // Garante que o objeto existe

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mission.name}</td>
                    <td>${mission.date}</td>
                    <td>${mission.reward}</td>
                    <td>${mission.agency}</td>
                    <td>${rewards.Akane || 0}</td>
                    <td>${rewards.Gemini || 0}</td>
                    <td>${rewards.Tilas || 0}</td>
                    <td>${rewards.Daemian || 0}</td>
                    <td>${rewards.Bart || 0}</td>
                    <td>${mission.summary}</td>
                    <td class="actions-cell">
                        <button class="edit-btn" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                        <br>
                        <button class="delete-btn" title="Excluir"><i class="fas fa-times"></i></button>
                    </td>`;
                row.querySelector('.edit-btn').addEventListener('click', () => editMission(missionId, mission));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteMissionAndFinances(missionId)); // ATUALIZADO
                tableBody.appendChild(row);
            });
        });
    </script>
</body>
</html>