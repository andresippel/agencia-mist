<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumo de Missões - Agência MIST</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .characters-input { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .characters-input .form-group { flex-grow: 1; min-width: 120px; }
        #missions-table th, #missions-table td { text-align: center; }
        #missions-table .actions-cell { width: 120px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Resumo de Missões</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="form-container">
            <h3 id="form-title">Adicionar Nova Missão</h3>
            <form id="mission-form">
                <input type="hidden" id="mission-id">
                <div class="form-group">
                    <label for="name">Nome da Missão</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="date">Data (Ex: 01/01/20)</label>
                    <input type="text" id="date" required>
                </div>
                <div class="form-group">
                    <label for="totalReward">Recompensa Total</label>
                    <input type="number" id="totalReward" min="0" value="0">
                </div>
                <div class="characters-input">
                    <div class="form-group">
                        <label for="akaneReward">Akane</label>
                        <input type="number" id="akaneReward" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="geminiReward">Gemini</label>
                        <input type="number" id="geminiReward" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="tilasReward">Tilas</label>
                        <input type="number" id="tilasReward" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="daemianReward">Daemian</label>
                        <input type="number" id="daemianReward" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="bartReward">Bart</label>
                        <input type="number" id="bartReward" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="summary">Resumo</label>
                    <textarea id="summary" rows="5"></textarea>
                </div>
                <button type="submit" id="submit-btn">Salvar Missão</button>
                <button type="button" id="cancel-btn" style="display:none;">Cancelar Edição</button>
            </form>
        </div>

        <div class="table-container">
            <table id="missions-table">
                <thead>
                    <tr>
                        <th>Missão</th>
                        <th>Data</th>
                        <th>Recompensa</th>
                        <th>Agência</th>
                        <th>Akane</th>
                        <th>Gemini</th>
                        <th>Tilas</th>
                        <th>Daemian</th>
                        <th>Bart</th>
                        <th>Resumo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="missions-table-body">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        
        const db = firebase.firestore();

        const missionsCollection = db.collection("missions");
        // ADICIONADO: Referência para a coleção de finanças
        const financesCollection = db.collection("finances");

        const form = document.getElementById('mission-form');
        const listBody = document.getElementById('missions-table-body');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const missionIdInput = document.getElementById('mission-id');

        const characters = ["Akane", "Gemini", "Tilas", "Daemian", "Bart"];

        const resetForm = () => {
            form.reset();
            formTitle.textContent = 'Adicionar Nova Missão';
            submitBtn.textContent = 'Salvar Missão';
            cancelBtn.style.display = 'none';
            missionIdInput.value = '';
        };

        const deleteMission = async (id) => {
            if (confirm("Tem certeza que deseja excluir esta missão?")) {
                await missionsCollection.doc(id).delete();
            }
        };

        const editMission = (id, data) => {
            missionIdInput.value = id;
            document.getElementById('name').value = data.name;
            document.getElementById('date').value = data.date;
            document.getElementById('totalReward').value = data.totalReward || 0;
            document.getElementById('akaneReward').value = data.Akane || 0;
            document.getElementById('geminiReward').value = data.Gemini || 0;
            document.getElementById('tilasReward').value = data.Tilas || 0;
            document.getElementById('daemianReward').value = data.Daemian || 0;
            document.getElementById('bartReward').value = data.Bart || 0;
            document.getElementById('summary').value = data.summary;
            formTitle.textContent = 'Editar Missão';
            submitBtn.textContent = 'Atualizar Missão';
            cancelBtn.style.display = 'inline-block';
        };

        cancelBtn.addEventListener('click', resetForm);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const missionData = {
                name: document.getElementById('name').value,
                date: document.getElementById('date').value,
                totalReward: parseInt(document.getElementById('totalReward').value) || 0,
                Akane: parseInt(document.getElementById('akaneReward').value) || 0,
                Gemini: parseInt(document.getElementById('geminiReward').value) || 0,
                Tilas: parseInt(document.getElementById('tilasReward').value) || 0,
                Daemian: parseInt(document.getElementById('daemianReward').value) || 0,
                Bart: parseInt(document.getElementById('bartReward').value) || 0,
                summary: document.getElementById('summary').value,
                createdAt: new Date().toISOString()
            };

            const missionId = missionIdInput.value;
            try {
                if (missionId) {
                    await missionsCollection.doc(missionId).update(missionData);
                } else {
                    await missionsCollection.add(missionData);
                    
                    // NOVO CÓDIGO: Adiciona entradas de finanças automaticamente
                    const financePromises = characters.map(char => {
                        const reward = missionData[char];
                        if (reward > 0) {
                            return financesCollection.add({
                                character: char,
                                amount: reward,
                                description: `Recompensa - ${missionData.name}`,
                                type: 'ganho'
                            });
                        }
                        return Promise.resolve(); // Retorna uma Promise resolvida para manter o array
                    });
                    
                    await Promise.all(financePromises);
                }
                resetForm();
            } catch (error) {
                console.error("Erro ao salvar a missão: ", error);
                alert("Erro ao salvar a missão. Verifique o console.");
            }
        });

        missionsCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
            listBody.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const mission = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mission.name}</td>
                    <td>${mission.date}</td>
                    <td>${mission.totalReward || 0}</td>
                    <td>${mission.agencyReward || 0}</td>
                    <td>${mission.Akane || 0}</td>
                    <td>${mission.Gemini || 0}</td>
                    <td>${mission.Tilas || 0}</td>
                    <td>${mission.Daemian || 0}</td>
                    <td>${mission.Bart || 0}</td>
                    <td><pre>${mission.summary}</pre></td>
                    <td class="actions-cell">
                        <button class="edit-btn">Editar</button>
                        <button class="delete-btn">Excluir</button>
                    </td>
                `;
                row.querySelector('.edit-btn').addEventListener('click', () => editMission(doc.id, mission));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteMission(doc.id));
                listBody.appendChild(row);
            });
        });
    </script>
</body>
</html>