<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Relatórios - Agência MIST</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>

    <link rel="stylesheet" href="style.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        .form-switcher { margin-bottom: 20px; }
        .form-switcher button { background-color: #ecf0f1; color: #34495e; }
        .form-switcher button.active { background-color: #3498db; color: #fff; }
        #editor-container { height: 400px; }
        .report-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; border-bottom: 1px solid #eee; }
        .report-title-text { font-weight: bold; color: #34495e; text-decoration: none; flex-grow: 1; }
        .report-actions a, .report-actions button { margin-left: 10px; text-decoration: none; padding: 5px 12px; font-size: 0.8em; color: white; border-radius: 4px; border: none; cursor: pointer; }
        .view-btn { background-color: #3498db; }
        .edit-btn { background-color: #f39c12; }
        .delete-btn { background-color: #e74c3c; }
        #upload-progress { margin-top: 10px; color: #2c3e50; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gerenciar Relatórios</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="form-container">
            <h3>Adicionar Novo Relatório</h3>
            <div class="form-switcher">
                <button id="show-editor-btn" class="active">Escrever Relatório</button>
                <button id="show-upload-btn">Fazer Upload de PDF</button>
            </div>

            <div id="editor-form">
                <input type="hidden" id="editor-report-id">
                <div class="form-group">
                    <label for="editor-report-title">Título do Relatório</label>
                    <input type="text" id="editor-report-title" placeholder="Título do relatório escrito...">
                </div>
                <div id="editor-container"></div>
                <br>
                <button id="save-text-report-btn">Salvar Relatório</button>
                <button id="cancel-edit-btn" style="display: none;">Cancelar Edição</button>
            </div>

            <div id="upload-form" style="display:none;">
                <div class="form-group">
                    <label for="pdf-report-title">Título do Relatório</label>
                    <input type="text" id="pdf-report-title" placeholder="Título do arquivo PDF..." required>
                </div>
                <div class="form-group">
                    <label for="pdf-file">Arquivo PDF</label>
                    <input type="file" id="pdf-file" accept=".pdf" required>
                </div>
                <button id="upload-pdf-btn">Fazer Upload do PDF</button>
                <div id="upload-progress"></div>
            </div>
        </div>

        <div id="reports-list" style="margin-top: 30px;">
            <h3>Relatórios Salvos</h3>
            <div id="reports-list-body"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const db = firebase.firestore();
        const storage = firebase.storage();
        const reportsCollection = db.collection("reports");

        // --- Elementos dos Formulários ---
        const showEditorBtn = document.getElementById('show-editor-btn');
        const showUploadBtn = document.getElementById('show-upload-btn');
        const editorForm = document.getElementById('editor-form');
        const uploadForm = document.getElementById('upload-form');
        const reportsListBody = document.getElementById('reports-list-body');

        // --- Lógica para alternar entre os formulários ---
        showEditorBtn.addEventListener('click', () => {
            editorForm.style.display = 'block';
            uploadForm.style.display = 'none';
            showEditorBtn.classList.add('active');
            showUploadBtn.classList.remove('active');
        });
        showUploadBtn.addEventListener('click', () => {
            editorForm.style.display = 'none';
            uploadForm.style.display = 'block';
            showEditorBtn.classList.remove('active');
            showUploadBtn.classList.add('active');
        });

        // --- Lógica do Editor de Texto (Quill) ---
        const BlockEmbed = Quill.import('blots/block/embed');
        class HorizontalRule extends BlockEmbed {}
        HorizontalRule.blotName = 'hr'; HorizontalRule.tagName = 'hr';
        Quill.register(HorizontalRule);
        const icons = Quill.import('ui/icons');
        icons['hr'] = `<svg viewbox="0 0 18 18"><line class="ql-stroke" x1="0" x2="18" y1="9" y2="9"></line></svg>`;
        function insertHorizontalRule() { const range = quill.getSelection(true); quill.insertText(range.index, '\n', Quill.sources.USER); quill.insertEmbed(range.index + 1, 'hr', true, Quill.sources.USER); quill.setSelection(range.index + 2, Quill.sources.SILENT); }
        
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], [{ 'align': [] }], ['link', 'image', 'hr'], ['clean'] ],
                    handlers: { 'hr': insertHorizontalRule }
                }
            }
        });
        const editorReportId = document.getElementById('editor-report-id');
        const editorReportTitle = document.getElementById('editor-report-title');
        const saveTextReportBtn = document.getElementById('save-text-report-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        quill.getModule('toolbar').addHandler('image', () => {
            const input = document.createElement('input'); input.setAttribute('type', 'file'); input.setAttribute('accept', 'image/*'); input.click();
            input.onchange = async () => {
                const file = input.files[0]; if (!file) return; const range = quill.getSelection(true); quill.insertText(range.index, "\n[ Carregando imagem... ]\n", 'user');
                try {
                    const storageRef = storage.ref().child(`reports_images/${Date.now()}_${file.name}`);
                    const snapshot = await storageRef.put(file); const url = await snapshot.ref.getDownloadURL();
                    quill.deleteText(range.index + 1, 25); quill.insertEmbed(range.index + 1, 'image', url);
                } catch (error) { console.error("Erro no upload da imagem:", error); quill.deleteText(range.index + 1, 25); alert("Falha no upload da imagem."); }
            };
        });

        saveTextReportBtn.addEventListener('click', async () => {
            const id = editorReportId.value;
            const title = editorReportTitle.value;
            const content = quill.root.innerHTML;
            if (!title) { alert("Adicione um título."); return; }
            
            const reportData = { title, content, type: 'text' };
            if (id) {
                await reportsCollection.doc(id).update(reportData);
            } else {
                reportData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await reportsCollection.add(reportData);
            }
            alert("Relatório de texto salvo!");
            editorReportId.value = ''; editorReportTitle.value = ''; quill.root.innerHTML = '';
            cancelEditBtn.style.display = 'none';
        });
        
        cancelEditBtn.addEventListener('click', () => {
            editorReportId.value = ''; editorReportTitle.value = ''; quill.root.innerHTML = '';
            cancelEditBtn.style.display = 'none';
        });

        // --- Lógica de Upload de PDF ---
        const uploadPdfBtn = document.getElementById('upload-pdf-btn');
        const pdfReportTitle = document.getElementById('pdf-report-title');
        const pdfFileField = document.getElementById('pdf-file');
        const uploadProgress = document.getElementById('upload-progress');

        uploadPdfBtn.addEventListener('click', async () => {
            const title = pdfReportTitle.value; const file = pdfFileField.files[0];
            if (!title || !file) { alert("Preencha o título e selecione um PDF."); return; }
            uploadProgress.textContent = 'Enviando...';
            try {
                const filePath = `reports_pdfs/${Date.now()}_${file.name}`;
                const storageRef = storage.ref(filePath);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                await reportsCollection.add({ title, fileURL: url, filePath, type: 'pdf', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                uploadProgress.textContent = 'Upload concluído!';
                pdfReportTitle.value = ''; pdfFileField.value = '';
                setTimeout(() => { uploadProgress.textContent = ''; }, 3000);
            } catch (error) { console.error("Erro no upload:", error); uploadProgress.textContent = 'Erro no upload.'; }
        });
        
        // --- Funções Globais ---
        window.loadReport = (id, title, content) => {
            showEditorBtn.click();
            editorReportId.value = id;
            editorReportTitle.value = title;
            quill.root.innerHTML = content;
            cancelEditBtn.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        window.deleteReport = async (docId, report) => {
            if (!confirm(`Tem certeza que deseja excluir o relatório "${report.title}"?`)) return;
            try {
                if (report.type === 'pdf' && report.filePath) { await storage.ref(report.filePath).delete(); }
                await reportsCollection.doc(docId).delete();
                alert("Relatório excluído.");
            } catch (error) { console.error("Erro ao excluir:", error); alert("Ocorreu um erro ao excluir."); }
        };

        // --- Renderização da Lista ---
        reportsCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
            reportsListBody.innerHTML = '';
            snapshot.docs.forEach(doc => {
                const report = doc.data();
                const itemDiv = document.createElement('div');
                itemDiv.className = 'report-list-item';
                const titleEl = document.createElement('div');
                titleEl.className = 'report-title-text';
                titleEl.textContent = `${report.title} (${report.type === 'pdf' ? 'PDF' : 'Texto'})`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'report-actions';
                const viewBtn = document.createElement('a');
                viewBtn.className = 'view-btn'; viewBtn.textContent = 'Ver'; viewBtn.target = '_blank';
                if (report.type === 'pdf') { viewBtn.href = report.fileURL; }
                else { viewBtn.href = `ver-relatorio.html?id=${doc.id}`; }
                actionsDiv.appendChild(viewBtn);
                if (report.type === 'text') {
                    const editButton = document.createElement('button');
                    editButton.className = 'edit-btn'; editButton.textContent = 'Editar';
                    editButton.onclick = () => loadReport(doc.id, report.title, report.content);
                    actionsDiv.appendChild(editButton);
                }
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn'; deleteButton.textContent = 'Excluir';
                deleteButton.onclick = () => deleteReport(doc.id, report);
                actionsDiv.appendChild(deleteButton);
                itemDiv.appendChild(titleEl); itemDiv.appendChild(actionsDiv); reportsListBody.appendChild(itemDiv);
            });
        });
    </script>
</body>
</html>