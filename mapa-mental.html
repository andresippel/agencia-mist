<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Mental - Agência MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>

    <link rel="stylesheet" href="style.css">
    <style>
        .markmap {
            width: 100%;
            height: 75vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        /* Estilos para a área de edição */
        #editor-container {
            display: none; /* Começa escondido */
            margin-top: 20px;
        }
        #markdown-editor {
            width: 100%;
            height: 400px;
            font-family: monospace;
            font-size: 14px;
        }
        .editor-actions {
            margin-top: 10px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mapa Mental do Universo</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" id="toggle-editor-btn" style="margin-right: 20px;">Modo Edição</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <svg class="markmap"></svg>

        <div id="editor-container">
            <h3>Editando o Mapa Mental</h3>
            <textarea id="markdown-editor" placeholder="Cole ou edite seu texto em formato Markdown aqui..."></textarea>
            <div class="editor-actions">
                <button id="save-btn">Salvar Alterações</button>
            </div>
        </div>

    </div> <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-view@0.15"></script>
    <script src="https://cdn.jsdelivr.net/npm/markmap-lib@0.15"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const mindmapDocRef = db.collection("conteudo").doc("mapa-mental");

        const { Transformer, Markmap } = window.markmap;
        const transformer = new Transformer();
        const svgEl = document.querySelector('.markmap');
        
        let markmapInstance; // Variável para guardar a instância do mapa

        // Elementos do editor
        const editorContainer = document.getElementById('editor-container');
        const editorTextarea = document.getElementById('markdown-editor');
        const toggleEditorBtn = document.getElementById('toggle-editor-btn');
        const saveBtn = document.getElementById('save-btn');

        // Função para renderizar o mapa mental
        function renderMindmap(markdown) {
          // Limpa o SVG anterior antes de desenhar um novo
          svgEl.innerHTML = '';
          const { root } = transformer.transform(markdown);
          // Cria ou atualiza o mapa
          if (markmapInstance) {
            markmapInstance.setData(root);
          } else {
            markmapInstance = Markmap.create(svgEl, null, root);
          }
        }

        // Função para carregar os dados do Firestore
        function loadMindmapFromDB() {
          mindmapDocRef.onSnapshot(doc => {
            if (doc.exists) {
              const markdown = doc.data().markdown;
              editorTextarea.value = markdown; // Atualiza o editor
              renderMindmap(markdown); // Renderiza o mapa
            } else {
              console.log("Documento do mapa mental não encontrado!");
              // Você pode renderizar um mapa padrão ou mostrar uma mensagem
              renderMindmap("# Mapa não encontrado\n- Crie o documento 'mapa-mental' no Firestore.");
            }
          });
        }
        
        // Alternar a visibilidade do editor
        toggleEditorBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isHidden = editorContainer.style.display === 'none' || editorContainer.style.display === '';
            editorContainer.style.display = isHidden ? 'block' : 'none';
        });

        // Salvar as alterações no Firestore
        saveBtn.addEventListener('click', async () => {
          const newMarkdown = editorTextarea.value;
          try {
            await mindmapDocRef.set({ markdown: newMarkdown });
            alert("Mapa mental salvo com sucesso!");
            editorContainer.style.display = 'none'; // Esconde o editor após salvar
          } catch (error) {
            console.error("Erro ao salvar o mapa mental: ", error);
            alert("Ocorreu um erro ao salvar. Verifique o console.");
          }
        });

        // Carrega o mapa mental quando a página abre
        loadMindmapFromDB();
      });
    </script>
</body>
</html>