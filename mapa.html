<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa Virtual - Ag√™ncia MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        body { overflow: hidden; /* Evita barras de rolagem duplas */ }
        
        /* Layout Principal */
        .vtt-container { display: flex; height: 90vh; gap: 10px; }
        
        /* Painel de Controle (Esquerda) */
        .controls-panel {
            width: 250px; background: #2c3e50; color: white; padding: 15px;
            display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto;
        }
        .control-group { background: #34495e; padding: 10px; border-radius: 5px; }
        .control-group h4 { margin: 0 0 10px 0; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; font-size: 0.9em; text-transform: uppercase;}
        .input-dark { width: 100%; padding: 5px; margin-bottom: 5px; background: #ecf0f1; border: none; border-radius: 3px; }
        .btn-vtt { width: 100%; padding: 8px; border: none; cursor: pointer; border-radius: 3px; font-weight: bold; margin-bottom: 5px; }
        .btn-green { background: #27ae60; color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #c0392b; color: white; }

        /* √Årea do Mapa (Direita) */
        .map-area {
            flex: 1; background: #111; position: relative; overflow: hidden;
            border: 2px solid #555; border-radius: 5px;
            cursor: grab;
        }
        .map-area:active { cursor: grabbing; }

        /* O Mapa em si (Imagem de Fundo) */
        #game-map {
            position: absolute; top: 0; left: 0;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out; /* Suaviza o zoom */
        }

        /* Tokens */
        .token {
            position: absolute; width: 50px; height: 50px;
            border-radius: 50%; border: 3px solid white;
            background-size: cover; background-position: center; background-color: #777;
            cursor: grab; z-index: 10;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: white; text-shadow: 0 0 3px black; user-select: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
            transition: box-shadow 0.2s;
        }
        .token:active { cursor: grabbing; box-shadow: 0 0 15px yellow; z-index: 100; }
        .token-label {
            position: absolute; bottom: -20px; background: rgba(0,0,0,0.7);
            color: white; padding: 2px 5px; font-size: 10px; border-radius: 3px;
            white-space: nowrap; pointer-events: none;
        }

        /* Handout Modal (Pop-up de Imagem) */
        .handout-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .handout-img { max-width: 90%; max-height: 85vh; border: 5px solid white; border-radius: 5px; box-shadow: 0 0 20px black; }
        .handout-btn { margin-top: 15px; padding: 10px 20px; font-size: 1.2em; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 5px; }

    </style>
</head>
<body>
    <div class="container" style="max-width: 100%; height: 100vh; padding: 10px;">
        <header style="margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;">
            <h1 style="margin:0; font-size:1.5em;">Mesa Virtual MIST</h1>
            <nav>
                <a href="index.html">Voltar</a>
            </nav>
        </header>

        <div class="vtt-container">
            <div class="controls-panel">
                <div class="control-group">
                    <h4>üó∫Ô∏è Mapa</h4>
                    <input type="text" id="map-url" class="input-dark" placeholder="URL da Imagem do Mapa">
                    <button class="btn-vtt btn-blue" onclick="setMap()">Mudar Mapa</button>
                    <div style="font-size: 0.8em; color: #ccc; margin-top:5px;">
                        Use Bot√£o Direito para arrastar o mapa. Scroll para Zoom.
                    </div>
                </div>

                <div class="control-group">
                    <h4>‚ôüÔ∏è Tokens</h4>
                    <input type="text" id="token-name" class="input-dark" placeholder="Nome (ex: Akane)">
                    <input type="text" id="token-img" class="input-dark" placeholder="URL da Imagem (Opcional)">
                    <button class="btn-vtt btn-green" onclick="createToken()">Criar Token</button>
                    <button class="btn-vtt btn-blue" onclick="importFromSheets()">Importar Fichas</button>
                </div>

                <div class="control-group">
                    <h4>üìú Handout (Exibir)</h4>
                    <input type="text" id="handout-url" class="input-dark" placeholder="URL da Imagem">
                    <button class="btn-vtt btn-blue" onclick="showHandout()">Exibir para Todos</button>
                    <button class="btn-vtt btn-red" onclick="clearHandout()">Fechar para Todos</button>
                </div>

                <div class="control-group">
                    <h4>üéµ M√∫sica / Som</h4>
                    <input type="text" id="music-url" class="input-dark" placeholder="Link (YouTube/MP3)">
                    <button class="btn-vtt btn-blue" onclick="updateMusic()">Enviar Link</button>
                    <div id="music-player-area" style="margin-top:10px;">
                        </div>
                </div>
            </div>

            <div class="map-area" id="map-area">
                <img id="game-map" src="" alt="Sem mapa carregado" draggable="false">
                <div id="tokens-layer"></div>
            </div>
        </div>
    </div>

    <div id="handout-modal" class="handout-overlay">
        <img id="handout-image" class="handout-img" src="">
        <button class="handout-btn" onclick="closeLocalHandout()">Fechar</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore();
            
            // Refer√™ncias de Cole√ß√£o
            // Vamos usar 'mesa_virtual' como cole√ß√£o principal
            // Documento 'config': guarda mapa atual, handout atual, musica atual
            // Cole√ß√£o 'tokens': guarda cada token individualmente
            const configRef = db.collection('mesa_virtual').doc('config');
            const tokensRef = db.collection('mesa_virtual').doc('data').collection('tokens');

            // Elementos DOM
            const mapArea = document.getElementById('map-area');
            const gameMap = document.getElementById('game-map');
            const tokensLayer = document.getElementById('tokens-layer');
            const handoutModal = document.getElementById('handout-modal');
            const handoutImage = document.getElementById('handout-image');

            // Vari√°veis de Estado Local (Zoom/Pan)
            let scale = 1;
            let panX = 0;
            let panY = 0;
            let isPanning = false;
            let startPanX, startPanY;

            // --- 1. SINCRONIZA√á√ÉO DE CONFIGURA√á√ÉO (MAPA, HANDOUT, MUSICA) ---
            configRef.onSnapshot(doc => {
                if(doc.exists) {
                    const data = doc.data();
                    
                    // Atualiza Mapa
                    if(data.mapUrl && gameMap.src !== data.mapUrl) {
                        gameMap.src = data.mapUrl;
                    }

                    // Atualiza Handout
                    if(data.handoutUrl && data.handoutActive) {
                        handoutImage.src = data.handoutUrl;
                        handoutModal.style.display = 'flex';
                    } else if (!data.handoutActive) {
                        handoutModal.style.display = 'none';
                    }

                    // Atualiza Musica (Apenas mostra o link/player, autoplay √© bloqueado por browsers)
                    if(data.musicUrl) {
                        renderMusicPlayer(data.musicUrl);
                    }
                } else {
                    // Se n√£o existe config, cria
                    configRef.set({ mapUrl: '', handoutUrl: '', handoutActive: false });
                }
            });

            // --- 2. SINCRONIZA√á√ÉO DE TOKENS ---
            tokensRef.onSnapshot(snapshot => {
                // Para simplificar, limpamos e redesenhamos. Em produ√ß√£o real, far√≠amos diff.
                tokensLayer.innerHTML = ''; 
                
                snapshot.forEach(doc => {
                    const t = doc.data();
                    const el = document.createElement('div');
                    el.className = 'token';
                    el.id = doc.id;
                    el.style.left = t.x + 'px';
                    el.style.top = t.y + 'px';
                    
                    if(t.img) {
                        el.style.backgroundImage = `url('${t.img}')`;
                        el.innerText = '';
                    } else {
                        el.style.backgroundColor = t.color || '#e74c3c';
                        el.innerText = t.name.substring(0,2).toUpperCase();
                    }

                    // Label com nome
                    const label = document.createElement('div');
                    label.className = 'token-label';
                    label.textContent = t.name;
                    el.appendChild(label);

                    // Bot√£o de deletar (pequeno X)
                    const delBtn = document.createElement('div');
                    delBtn.innerHTML = '√ó';
                    delBtn.style.cssText = 'position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; width:15px; height:15px; font-size:10px; line-height:15px; text-align:center; cursor:pointer; display:none;';
                    el.appendChild(delBtn);

                    // Eventos do Token
                    el.onmouseenter = () => delBtn.style.display = 'block';
                    el.onmouseleave = () => delBtn.style.display = 'none';
                    delBtn.onclick = (e) => { e.stopPropagation(); deleteToken(doc.id); };
                    
                    el.onmousedown = (e) => startDragToken(e, doc.id, t.x, t.y);

                    tokensLayer.appendChild(el);
                });
            });

            // --- FUN√á√ïES DE CONTROLE (Mestre) ---

            window.setMap = () => {
                const url = document.getElementById('map-url').value;
                if(url) configRef.update({ mapUrl: url });
            };

            window.showHandout = () => {
                const url = document.getElementById('handout-url').value;
                if(url) configRef.update({ handoutUrl: url, handoutActive: true });
            };

            window.clearHandout = () => {
                configRef.update({ handoutActive: false });
            };
            
            window.closeLocalHandout = () => {
                handoutModal.style.display = 'none';
                // Nota: Isso fecha s√≥ para voc√™. Se for mestre, deveria usar "Fechar para Todos".
            };

            window.updateMusic = () => {
                const url = document.getElementById('music-url').value;
                if(url) configRef.update({ musicUrl: url });
            }

            window.createToken = () => {
                const name = document.getElementById('token-name').value || "Token";
                const img = document.getElementById('token-img').value;
                
                tokensRef.add({
                    name: name,
                    img: img,
                    x: 100, // Posi√ß√£o padr√£o
                    y: 100,
                    color: '#' + Math.floor(Math.random()*16777215).toString(16)
                });
            };
            
            window.deleteToken = (id) => {
                if(confirm("Deletar token?")) tokensRef.doc(id).delete();
            }

            window.importFromSheets = async () => {
                const snapshot = await db.collection("personagens").get();
                snapshot.forEach(doc => {
                    const char = doc.data();
                    tokensRef.add({
                        name: char.nome,
                        img: "", // Se tivesse imagem na ficha, usaria aqui
                        x: 50 + Math.random()*100,
                        y: 50 + Math.random()*100,
                        color: '#3498db'
                    });
                });
                alert("Personagens importados como tokens!");
            };

            // --- L√ìGICA DE ARRASTAR TOKEN (DRAG AND DROP) ---
            let activeTokenId = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;

            function startDragToken(e, id, currentX, currentY) {
                if(e.button !== 0) return; // S√≥ bot√£o esquerdo
                e.preventDefault();
                activeTokenId = id;
                
                // Calcula onde o mouse pegou no token (para n√£o pular)
                // Precisamos considerar o Zoom (scale) e Pan
                const tokenEl = document.getElementById(id);
                const rect = tokenEl.getBoundingClientRect();
                
                // Diferen√ßa entre o mouse e o topo/esquerda do token visual
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;

                document.addEventListener('mousemove', onDragToken);
                document.addEventListener('mouseup', stopDragToken);
            }

            function onDragToken(e) {
                if(!activeTokenId) return;
                const el = document.getElementById(activeTokenId);
                
                // Posi√ß√£o do mouse relativa ao container do mapa
                const mapRect = mapArea.getBoundingClientRect();
                
                // Matem√°tica reversa para considerar Zoom e Pan na posi√ß√£o absoluta
                // X_real = (MouseX - MapLeft - PanX) / Scale - DragOffset
                const rawX = (e.clientX - mapRect.left - panX) / scale;
                const rawY = (e.clientY - mapRect.top - panY) / scale;
                
                // Ajuste fino do offset visual
                // Como o elemento est√° dentro do container transformado, definimos left/top brutos
                // Mas precisamos compensar o offset do clique inicial tamb√©m escalado? 
                // Simplifica√ß√£o: Movemos visualmente apenas, a posi√ß√£o final salva.
                
                el.style.left = rawX + 'px';
                el.style.top = rawY + 'px';
            }

            function stopDragToken(e) {
                if(!activeTokenId) return;
                const el = document.getElementById(activeTokenId);
                
                // Salva posi√ß√£o final no Firestore
                const x = parseFloat(el.style.left);
                const y = parseFloat(el.style.top);
                
                tokensRef.doc(activeTokenId).update({ x, y });

                activeTokenId = null;
                document.removeEventListener('mousemove', onDragToken);
                document.removeEventListener('mouseup', stopDragToken);
            }

            // --- L√ìGICA DE ZOOM E PAN DO MAPA ---
            
            // Pan (Bot√£o Direito)
            mapArea.addEventListener('mousedown', (e) => {
                if(e.button === 2) { // Direito
                    e.preventDefault();
                    isPanning = true;
                    startPanX = e.clientX - panX;
                    startPanY = e.clientY - panY;
                    mapArea.style.cursor = 'grabbing';
                }
            });

            window.addEventListener('mousemove', (e) => {
                if(!isPanning) return;
                e.preventDefault();
                panX = e.clientX - startPanX;
                panY = e.clientY - startPanY;
                applyTransform();
            });

            window.addEventListener('mouseup', () => {
                isPanning = false;
                mapArea.style.cursor = 'grab';
            });
            
            // Desabilita menu de contexto do bot√£o direito
            mapArea.addEventListener('contextmenu', e => e.preventDefault());

            // Zoom (Roda do Mouse)
            mapArea.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoomIntensity = 0.1;
                if (e.deltaY < 0) {
                    scale += zoomIntensity;
                } else {
                    scale -= zoomIntensity;
                }
                scale = Math.min(Math.max(.125, scale), 4); // Limites de zoom
                applyTransform();
            });

            function applyTransform() {
                // Aplica Zoom e Pan no Mapa e na Camada de Tokens
                const transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
                gameMap.style.transform = transform;
                tokensLayer.style.transform = transform;
                tokensLayer.style.transformOrigin = "0 0";
            }

            // --- PLAYER DE M√öSICA ---
            function renderMusicPlayer(url) {
                const container = document.getElementById('music-player-area');
                container.innerHTML = '';
                
                if(url.includes('youtube.com') || url.includes('youtu.be')) {
                    // Extrai ID do Youtube
                    let videoId = "";
                    if(url.includes('v=')) videoId = url.split('v=')[1].split('&')[0];
                    else if(url.includes('youtu.be/')) videoId = url.split('youtu.be/')[1];
                    
                    if(videoId) {
                        container.innerHTML = `<iframe width="220" height="100" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                    }
                } else if(url.endsWith('.mp3')) {
                    container.innerHTML = `<audio controls src="${url}" style="width:220px;"></audio>`;
                } else {
                    container.innerHTML = `<a href="${url}" target="_blank" style="color:#3498db;">üéµ Abrir Link de M√∫sica</a>`;
                }
            }

        });
    </script>
</body>
</html>