<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relações entre Personagens - Agência MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>

    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.0/dist/vis-network.min.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        .form-container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-container h3 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .table-actions button { margin-right: 5px; }
        .edit-btn { background-color: #3498db; }
        .delete-btn { background-color: #e74c3c; }
        .character-management { margin-bottom: 20px; text-align: right; }
        .add-character-form { display: none; margin-top: 15px; }
        
        /* Estilos do novo mapa de relações */
        #relationship-map {
            width: 100%;
            height: 600px;
            border: 1px solid lightgray;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .filter-options {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }
        .filter-options .form-group {
            flex: 1;
            margin-bottom: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Relações entre Personagens</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <main>
            <div class="character-management">
                <button id="show-add-char-btn" class="secondary-btn">Gerenciar Personagens</button>
                <div id="add-character-form-container" class="form-container add-character-form">
                    <h3>Adicionar Novo Personagem</h3>
                    <form id="add-character-form">
                        <div class="form-group">
                            <label for="new-char-name">Nome do Personagem:</label>
                            <input type="text" id="new-char-name" required>
                        </div>
                        <button type="submit">Adicionar</button>
                    </form>
                    <ul id="character-list"></ul>
                </div>
            </div>

            <div class="form-container">
                <h3 id="form-title">Adicionar Nova Relação</h3>
                <form id="social-link-form">
                    <input type="hidden" id="link-id">
                    <div class="form-group">
                        <label for="char1">Personagem 1:</label>
                        <select id="char1" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="char2">Personagem 2:</label>
                        <select id="char2" required>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="relationship">Nível de Relação (Ex: -100 a 100)</label>
                        <input type="number" id="relationship" required>
                    </div>
                    <button type="submit" id="submit-btn">Salvar Relação</button>
                    <button type="button" id="cancel-btn" style="display:none;">Cancelar Edição</button>
                </form>
            </div>

            <hr style="margin: 40px 0;">

            <div class="filter-options">
                <div class="form-group">
                    <label for="filter-char1">Filtrar por Personagem 1:</label>
                    <select id="filter-char1"></select>
                </div>
                <div class="form-group">
                    <label for="filter-char2">Filtrar por Personagem 2:</label>
                    <select id="filter-char2"></select>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Personagem 1</th>
                            <th>Personagem 2</th>
                            <th>Nível de Relação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="links-table-body">
                        </tbody>
                </table>
            </div>

            <hr style="margin: 40px 0;">

            <div class="form-container">
                <h3>Mapa de Relações</h3>
                <div id="relationship-map"></div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = { /* ...SEU OBJETO DE CONFIGURAÇÃO... */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const linksCollection = db.collection("social_links");
        const charactersCollection = db.collection("characters");

        const form = document.getElementById('social-link-form');
        const char1Select = document.getElementById('char1');
        const char2Select = document.getElementById('char2');
        const relationshipInput = document.getElementById('relationship');
        const linksTableBody = document.getElementById('links-table-body');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const linkIdInput = document.getElementById('link-id');

        const showAddCharBtn = document.getElementById('show-add-char-btn');
        const addCharFormContainer = document.getElementById('add-character-form-container');
        const addCharForm = document.getElementById('add-character-form');
        const newCharNameInput = document.getElementById('new-char-name');
        const characterList = document.getElementById('character-list');

        const filterChar1Select = document.getElementById('filter-char1');
        const filterChar2Select = document.getElementById('filter-char2');

        const mapContainer = document.getElementById('relationship-map');
        let network;
        let allRelationships = [];
        let allCharacters = [];

        showAddCharBtn.addEventListener('click', () => {
            const isVisible = addCharFormContainer.style.display === 'block';
            addCharFormContainer.style.display = isVisible ? 'none' : 'block';
        });

        addCharForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const charName = newCharNameInput.value.trim();
            if (charName) {
                await charactersCollection.add({ name: charName });
                newCharNameInput.value = '';
            }
        });

        const deleteCharacter = async (id) => {
            if (confirm("Excluir este personagem?")) {
                await charactersCollection.doc(id).delete();
            }
        };

        // Escuta os personagens e links para atualizar o mapa
        charactersCollection.orderBy("name").onSnapshot(charSnapshot => {
            allCharacters = charSnapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));

            const populateSelects = (selectElement, chars) => {
                selectElement.innerHTML = `<option value="">Todos</option>`;
                chars.forEach(char => {
                    selectElement.innerHTML += `<option value="${char.name}">${char.name}</option>`;
                });
            };

            populateSelects(char1Select, allCharacters);
            populateSelects(char2Select, allCharacters);
            populateSelects(filterChar1Select, allCharacters);
            populateSelects(filterChar2Select, allCharacters);
            
            characterList.innerHTML = '';
            allCharacters.forEach(char => {
                const li = document.createElement('li');
                li.innerHTML = `${char.name} <button class="delete-btn" onclick="deleteCharacter('${char.id}')">X</button>`;
                characterList.appendChild(li);
            });

            // Atualiza o mapa de relações com os dados completos
            linksCollection.onSnapshot(linkSnapshot => {
                allRelationships = linkSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const nodes = new vis.DataSet(allCharacters.map(char => ({ id: char.name, label: char.name })));
                const edges = new vis.DataSet(allRelationships.map(link => {
                    let color = 'gray';
                    if (link.relationship > 0) {
                        color = '#27ae60';
                    } else if (link.relationship < 0) {
                        color = '#c0392b';
                    }
                    return { 
                        from: link.char1, 
                        to: link.char2, 
                        color: { color: color },
                        label: String(link.relationship),
                        arrows: 'to'
                    };
                }));

                const data = { nodes: nodes, edges: edges };
                const options = {
                    physics: { enabled: true, stabilizing: false },
                    edges: { smooth: true, width: 3 },
                    nodes: { shape: 'circle', size: 25 },
                    interaction: { hover: true, hoverConnectedEdges: true, selectable: true },
                    layout: { hierarchical: { enabled: false } }
                };

                if (network) {
                    network.destroy();
                }
                network = new vis.Network(mapContainer, data, options);
                updateTable();
            });
        });

        // Adiciona os eventos de filtro
        filterChar1Select.addEventListener('change', updateTable);
        filterChar2Select.addEventListener('change', updateTable);

        function updateTable() {
            const filter1 = filterChar1Select.value;
            const filter2 = filterChar2Select.value;
            
            linksTableBody.innerHTML = '';
            const filteredRelationships = allRelationships.filter(link => {
                const matchesChar1 = filter1 === "" || link.char1 === filter1;
                const matchesChar2 = filter2 === "" || link.char2 === filter2;
                return matchesChar1 && matchesChar2;
            });

            filteredRelationships.forEach(link => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${link.char1}</td>
                    <td>${link.char2}</td>
                    <td>${link.relationship}</td>
                    <td class="table-actions">
                        <button class="edit-btn">Editar</button>
                        <button class="delete-btn">Excluir</button>
                    </td>
                `;
                row.querySelector('.edit-btn').addEventListener('click', () => editLink(link.id, link));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteLink(link.id));
                linksTableBody.appendChild(row);
            });
        }
        
        function resetForm() {
            form.reset();
            formTitle.textContent = 'Adicionar Nova Relação';
            submitBtn.textContent = 'Salvar Relação';
            cancelBtn.style.display = 'none';
            linkIdInput.value = '';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                char1: char1Select.value,
                char2: char2Select.value,
                relationship: parseInt(relationshipInput.value),
            };
            const linkId = linkIdInput.value;
            try {
                if (linkId) {
                    await linksCollection.doc(linkId).update(data);
                } else {
                    await linksCollection.add(data);
                }
                resetForm();
            } catch (error) {
                console.error("Erro ao salvar a relação: ", error);
                alert("Erro ao salvar a relação. Verifique o console.");
            }
        });

        const deleteLink = async (id) => {
            if (confirm("Tem certeza que deseja excluir esta relação?")) {
                await linksCollection.doc(id).delete();
            }
        };

        const editLink = (id, data) => {
            linkIdInput.value = id;
            char1Select.value = data.char1;
            char2Select.value = data.char2;
            relationshipInput.value = data.relationship;
            formTitle.textContent = 'Editar Relação';
            submitBtn.textContent = 'Atualizar Relação';
            cancelBtn.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        cancelBtn.addEventListener('click', resetForm);
        
        window.deleteCharacter = deleteCharacter;
    </script>
</body>
</html>