<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rela√ß√µes - Ag√™ncia MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="auth-check.js"></script>

    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.0/dist/vis-network.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    
    <link rel="stylesheet" href="style.css">
    <style>
        .form-container { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .form-container h3 { margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .edit-btn { background-color: #3498db; }
        .delete-btn { background-color: #e74c3c; }
        
        #relationship-map { width: 100%; height: 600px; border: 1px solid lightgray; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; border-radius: 10px; width: 80%; max-width: 600px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 10; }
        
        .modal-character-image { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin-bottom: 20px; border: 3px solid #ddd; cursor: pointer; }
        .modal-character-name { font-size: 2em; margin-bottom: 10px; color: #333; }
        
        #cropper-modal .modal-content { max-width: 80vw; max-height: 80vh; }
        #image-to-crop { max-width: 100%; max-height: 60vh; }
                
        #relationship-modal .image-container { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        #relationship-modal .rel-char-image { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #ddd; }
        #relationship-modal .rel-char-names { font-size: 1.5em; font-weight: bold; color: #333; }
        
        .social-hearts-container { display: flex; gap: 10px; margin-top: 20px; }
        .social-heart { cursor: pointer; transition: transform 0.2s ease; }
        .social-heart:hover { transform: scale(1.1); }
        .social-heart.filled path { fill: #e74c3c; }
        .social-heart.empty path { fill: none; stroke: #888; stroke-width: 25; }

        #bonus-display-area { margin-top: 15px; padding: 10px; width: 90%; min-height: 2.5em; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef; font-style: italic; color: #6c757d; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        
        .relationship-actions { margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; width: 100%; display: flex; justify-content: center; gap: 10px; }
        
        #full-image-modal .modal-content { padding: 5px; background-color: rgba(0,0,0,0.7); border: none; width: 95vw; height: 95vh; }
        #full-modal-image { max-width: 100%; max-height: 100%; object-fit: contain; cursor: grab; }
        #full-modal-image:active { cursor: grabbing; }
        .zoom-instruction { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); color: white; background-color: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 0.8em; pointer-events: none; }
        
        /* --- NOVO: ESTILO DO PAINEL DE GERENCIAMENTO --- */
        .panel-modal-content {
            background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888;
            width: 80%; max-width: 800px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; text-align: left; display: flex; flex-direction: column;
        }
        .panel-tabs { display: flex; border-bottom: 2px solid #ccc; margin-bottom: 20px; flex-shrink: 0; }
        .tab { padding: 10px 20px; cursor: pointer; font-size: 18px; border: none; background: none; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .tab.active { font-weight: bold; color: #007bff; border-bottom-color: #007bff; }
        .panel-toolbar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; flex-shrink: 0;}
        .search-bar { flex-grow: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        .character-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; overflow-y: auto; padding: 10px; background-color: #f9f9f9; border-radius: 5px; min-height: 200px; }
        .character-card { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .character-card:hover { transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .character-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; background-color: #eee; }
        .character-card .char-name { font-weight: bold; font-size: 14px; word-break: break-word; }
        .delete-icon { position: absolute; top: 5px; right: 5px; color: #e74c3c; cursor: pointer; font-size: 18px; display: none; background: rgba(255,255,255,0.7); border-radius: 50%; width: 24px; height: 24px; line-height: 24px; text-align: center; }
        .character-card:hover .delete-icon { display: block; }
        .add-character-card { justify-content: center; font-size: 24px; color: #aaa; border: 2px dashed #ccc; }
        .add-character-card .plus-icon { font-size: 40px; line-height: 1; }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Mapa de Rela√ß√µes</h1><nav><a href="index.html" style="margin-right: 20px;">P√°gina Inicial</a><a href="#" onclick="logout()">Sair</a></nav></header>
        <main>
            <div class="form-container"><div class="form-group"><label for="character-map-select" style="font-size: 1.2em;"><strong>Ver Mapa de:</strong></label><select id="character-map-select"><option value="Akane">Akane</option><option value="Gemini">Gemini</option><option value="Tilas">Tilas</option><option value="Daemian">Daemian</option></select></div></div>
            
            <div class="form-container">
                <button id="openCharacterManagerBtn" class="secondary-btn">Gerenciar Personagens</button>
            </div>

            <div id="character-forms-container" style="margin-top:20px;">
                <div class="form-container">
                    <h3>Criar Novo Personagem (NPC)</h3>
                    <form id="create-character-form">
                        <div class="form-group"><label for="new-char-name">Nome:</label><input type="text" id="new-char-name" required></div>
                        <button type="submit">Criar</button>
                    </form>
                </div>

                <div id="edit-form-wrapper" style="display: none;">
                    <div class="form-container">
                        <h3 id="char-form-title">Editar Personagem</h3>
                        <form id="character-details-form">
                            <input type="hidden" id="char-doc-id">
                            <div class="form-group"><label for="char-name">Nome:</label><input type="text" id="char-name" required></div>
                            <div class="form-group"><label for="char-image-upload">Imagem:</label><input type="file" id="char-image-upload" accept="image/*"></div>
                            <div class="form-group"><label for="char-thumb-url">URL da Miniatura (gerado):</label><input type="text" id="char-thumb-url" readonly></div>
                            <div class="form-group"><label for="char-original-url">URL Original (gerado):</label><input type="text" id="char-original-url" readonly></div>
                            <div class="form-group"><label for="char-description">Descri√ß√£o:</label><textarea id="char-description" rows="4"></textarea></div>
                            <div class="form-group"><label for="char-status">Status:</label><select id="char-status"><option value="ativo">Ativo</option><option value="arquivado">Arquivado</option></select></div>
                            <button type="submit">Salvar</button>
                            <button type="button" id="cancel-char-edit-btn">Cancelar</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="form-container"><h3>Criar Conex√£o</h3><form id="social-link-form"><div class="form-group"><label for="char1">De:</label><select id="char1" required></select></div><div class="form-group"><label for="char2">Para:</label><select id="char2" required></select></div><div class="form-group"><label for="relationship-description">Relacionamento:</label><textarea id="relationship-description" rows="3"></textarea></div><button type="submit">Criar</button></form></div>
            <hr style="margin: 40px 0;">
            <div class="form-container"><h3 id="map-title">Mapa de Rela√ß√µes de Akane</h3><p>D√™ um duplo clique em um personagem ou em uma linha para ver detalhes.</p><div id="relationship-map"></div></div>
        </main>
    </div>

    <div id="character-modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><img id="modal-image" src="" class="modal-character-image"><h2 id="modal-name"></h2><h4>Descri√ß√£o</h4><p id="modal-description"></p><button id="modal-edit-btn" class="edit-btn" style="margin-top: 20px;">Editar</button></div></div>
    <div id="cropper-modal" class="modal"><div class="modal-content"><h3>Recortar Imagem</h3><div><img id="image-to-crop" src=""></div><button id="save-crop-btn" class="edit-btn" style="margin-top: 20px;">Salvar</button></div></div>
    <div id="relationship-modal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><div class="image-container"><img id="rel-char1-image" class="rel-char-image"><span class="rel-char-names"><span id="rel-char1-name"></span> &harr; <span id="rel-char2-name"></span></span><img id="rel-char2-image" class="rel-char-image"></div><h4>Relacionamento</h4><p id="rel-description"></p><div id="social-hearts-container" class="social-hearts-container"></div><p id="bonus-display-area"></p><div class="relationship-actions"><button id="edit-relationship-btn" class="edit-btn">Editar</button><button id="delete-relationship-btn" class="delete-btn">Excluir</button></div></div></div>
    <div id="full-image-modal" class="modal"><div class="modal-content"><span class="close-button" style="color: #fff;">&times;</span><img id="full-modal-image" src=""><div class="zoom-instruction">Use a roda do mouse para dar zoom</div></div></div>

    <div id="characterManagerPanel" class="modal">
        <div class="panel-modal-content">
            <span id="closePanelButton" class="close-button">&times;</span>
            <h2>Gerenciar Personagens</h2>
            <div class="panel-tabs">
                <button id="tabAtivos" class="tab active">Ativos</button>
                <button id="tabArquivados" class="tab">Arquivados</button>
            </div>
            <div class="panel-toolbar">
                <input type="text" id="searchInput" class="search-bar" placeholder="üîç Buscar por nome...">
            </div>
            <div id="characterGrid" class="character-grid">
                </div>
        </div>
    </div>

    <script>
        const db = firebase.firestore();
        const storage = firebase.storage();
        const SOCIAL_LEVELS = ["", "Amigo", "Confidente", "V√≠nculo Inabal√°vel"];
        
        let network, cropper, panzoomInstance;
        let allRelationships = [], allCharacterDetails = {};
        let centralCharacter = 'Akane';
        let originalFileToUpload = null;

        // --- Elementos do DOM ---
        const mapTitle = document.getElementById('map-title');
        const characterMapSelect = document.getElementById('character-map-select');
        const relationshipModal = document.getElementById('relationship-modal');
        const socialHeartsContainer = document.getElementById('social-hearts-container');
        const characterModal = document.getElementById('character-modal');
        const cropperModal = document.getElementById('cropper-modal');
        const editFormWrapper = document.getElementById('edit-form-wrapper');
        const characterDetailsForm = document.getElementById('character-details-form');
        const cancelCharEditBtn = document.getElementById('cancel-char-edit-btn');
        const editRelationshipBtn = document.getElementById('edit-relationship-btn');
        const deleteRelationshipBtn = document.getElementById('delete-relationship-btn');
        const bonusDisplayArea = document.getElementById('bonus-display-area');
        const charThumbUrlInput = document.getElementById('char-thumb-url');
        const charOriginalUrlInput = document.getElementById('char-original-url');
        const imageToCrop = document.getElementById('image-to-crop');
        const fullImageModal = document.getElementById('full-image-modal');
        const fullModalImage = document.getElementById('full-modal-image');

        // --- Elementos do Novo Painel ---
        const charManagerPanel = document.getElementById('characterManagerPanel');
        const openCharManagerBtn = document.getElementById('openCharacterManagerBtn');
        const closePanelBtn = document.getElementById('closePanelButton');
        const charGrid = document.getElementById('characterGrid');
        const tabAtivos = document.getElementById('tabAtivos');
        const tabArquivados = document.getElementById('tabArquivados');
        const searchInput = document.getElementById('searchInput');
        let currentStatusFilter = 'ativo';
        
        // --- FUN√á√ïES EXISTENTES ---
        function drawRelationshipMap() {
            if (Object.keys(allCharacterDetails).length === 0 || !allCharacterDetails[centralCharacter]) return;
            mapTitle.textContent = `Mapa de Rela√ß√µes de ${centralCharacter}`;
            
            const relevantRelationships = allRelationships.filter(rel => rel.char1 === centralCharacter || rel.char2 === centralCharacter);
            const charactersInMap = new Set([centralCharacter]);
            relevantRelationships.forEach(rel => { charactersInMap.add(rel.char1); charactersInMap.add(rel.char2); });

            const nodes = new vis.DataSet();
            charactersInMap.forEach(charName => {
                const charData = allCharacterDetails[charName];
                if (!charData) return;
                const nodeOptions = { id: charData.name, label: charData.name, shape: 'circularImage', image: charData.image_thumb_url || charData.image_url || 'https://dummyimage.com/150x150/ccc/000.png&text=X', borderWidth: 3, size: 30 };
                if (charData.name === centralCharacter) Object.assign(nodeOptions, { group: 'central', fixed: true, x: 0, y: 0, size: 40 });
                nodes.add(nodeOptions);
            });

            const edges = new vis.DataSet(relevantRelationships.map(link => ({ id: link.id, from: link.char1, to: link.char2 })));
            
            const data = { nodes, edges };
            const options = { physics: { enabled: true, solver: 'barnesHut', barnesHut: { gravitationalConstant: -4000 } }, nodes: { font: { size: 16, color: '#333' } }, edges: { color: '#888', width: 2, smooth: true }, groups: { central: { color: { border: '#e67e22' } } } };
            
            const mapContainer = document.getElementById('relationship-map');
            if (network) network.destroy();
            network = new vis.Network(mapContainer, data, options);

            network.on("doubleClick", params => {
                if (params.nodes.length > 0) showCharacterModal(params.nodes[0]);
                else if (params.edges.length > 0) showRelationshipModal(params.edges[0]);
            });
        }

        async function showCharacterModal(characterName) {
            const details = allCharacterDetails[characterName];
            if (!details) return;
            
            const modalImage = document.getElementById('modal-image');
            modalImage.src = details.image_thumb_url || details.image_original_url || details.image_url || 'https://dummyimage.com/150x150/ccc/000.png&text=X';
            
            document.getElementById('modal-name').textContent = details.name;
            document.getElementById('modal-description').textContent = details.description || 'Nenhuma descri√ß√£o.';
            document.getElementById('modal-edit-btn').onclick = () => { characterModal.style.display = 'none'; editCharacterDetails(details.id, details); };
            
            modalImage.ondblclick = () => {
                const fullImageUrl = details.image_original_url || details.image_thumb_url || details.image_url;
                if(fullImageUrl) showFullImageModal(fullImageUrl);
            };

            characterModal.style.display = 'flex';
        }

        function showFullImageModal(imageUrl) {
            fullModalImage.src = imageUrl;
            fullImageModal.style.display = 'flex';
            
            if (panzoomInstance) panzoomInstance.destroy();
            panzoomInstance = Panzoom(fullModalImage, { maxScale: 5, minScale: 0.7 });
            fullImageModal.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
        }
        
        function closeFullImageModal() {
            if (panzoomInstance) {
                panzoomInstance.destroy();
                panzoomInstance = null;
            }
            fullImageModal.style.display = 'none';
        }

        async function showRelationshipModal(edgeId) {
            const relationship = allRelationships.find(rel => rel.id === edgeId);
            if (!relationship) return;
            const char1 = allCharacterDetails[relationship.char1], char2 = allCharacterDetails[relationship.char2];
            if (!char1 || !char2) return;

            editRelationshipBtn.dataset.linkId = edgeId;
            deleteRelationshipBtn.dataset.linkId = edgeId;

            document.getElementById('rel-char1-image').src = char1.image_thumb_url || char1.image_url || 'https://dummyimage.com/150x150/ccc/000.png&text=X';
            document.getElementById('rel-char2-image').src = char2.image_thumb_url || char2.image_url || 'https://dummyimage.com/150x150/ccc/000.png&text=X';
            document.getElementById('rel-char1-name').textContent = char1.name;
            document.getElementById('rel-char2-name').textContent = char2.name;
            document.getElementById('rel-description').textContent = relationship.description || "";

            socialHeartsContainer.innerHTML = '';
            const defaultBonusText = 'Passe o mouse ou clique em um cora√ß√£o para ver o b√¥nus.';
            bonusDisplayArea.textContent = defaultBonusText;
            bonusDisplayArea.style.fontStyle = 'italic';
            bonusDisplayArea.style.color = '#6c757d';

            const currentLevel = relationship.socialLink?.level || 0;
            const bonuses = relationship.socialLink?.bonuses || {};

            for (let i = 1; i <= 3; i++) {
                const heartSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                heartSVG.setAttribute('viewBox', '0 0 512 512'); heartSVG.setAttribute('width', '40'); heartSVG.classList.add('social-heart');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', 'M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z');
                heartSVG.appendChild(path);

                if (i <= currentLevel) {
                    heartSVG.classList.add('filled');
                    if (bonuses[i]) {
                        const bonusText = `N√≠vel ${i} (${SOCIAL_LEVELS[i]}): ${bonuses[i]}`;
                        heartSVG.addEventListener('mouseenter', () => { bonusDisplayArea.textContent = bonusText; bonusDisplayArea.style.fontStyle = 'normal'; bonusDisplayArea.style.color = '#212529'; });
                        heartSVG.addEventListener('click', () => { bonusDisplayArea.textContent = bonusText; bonusDisplayArea.style.fontStyle = 'normal'; bonusDisplayArea.style.color = '#212529'; });
                    }
                } else { heartSVG.classList.add('empty'); }
                
                heartSVG.addEventListener('mouseleave', () => { bonusDisplayArea.textContent = defaultBonusText; bonusDisplayArea.style.fontStyle = 'italic'; bonusDisplayArea.style.color = '#6c757d'; });
                heartSVG.addEventListener('dblclick', () => handleHeartDoubleClick(edgeId, i, currentLevel));
                socialHeartsContainer.appendChild(heartSVG);
            }
            relationshipModal.style.display = 'flex';
        }

        async function handleHeartDoubleClick(linkId, clickedLevel, currentLevel) {
            let updateSuccess = false;
            let bonusText = null;
            if (clickedLevel === currentLevel + 1) {
                bonusText = prompt(`N√≠vel "${SOCIAL_LEVELS[clickedLevel]}" alcan√ßado!\nDigite o b√¥nus:`);
                if (bonusText !== null) { await db.collection('social_links').doc(linkId).update({ 'socialLink.level': clickedLevel, [`socialLink.bonuses.${clickedLevel}`]: bonusText }); updateSuccess = true; }
            } else if (clickedLevel === currentLevel && clickedLevel > 0) {
                if (confirm(`Remover o n√≠vel "${SOCIAL_LEVELS[clickedLevel]}"?`)) { await db.collection('social_links').doc(linkId).update({ 'socialLink.level': currentLevel - 1, [`socialLink.bonuses.${currentLevel}`]: firebase.firestore.FieldValue.delete() }); updateSuccess = true; }
            }

            if (updateSuccess) {
                const relToUpdate = allRelationships.find(r => r.id === linkId);
                if (relToUpdate) {
                    if (!relToUpdate.socialLink) relToUpdate.socialLink = {};
                    if (!relToUpdate.socialLink.bonuses) relToUpdate.socialLink.bonuses = {};
                    relToUpdate.socialLink.level = clickedLevel === currentLevel ? currentLevel - 1 : clickedLevel;
                    if (clickedLevel === currentLevel) { delete relToUpdate.socialLink.bonuses[currentLevel]; } 
                    else if (bonusText !== null) { relToUpdate.socialLink.bonuses[clickedLevel] = bonusText; }
                }
                showRelationshipModal(linkId);
            }
        }

        const editCharacterDetails = (docId, data) => {
            charManagerPanel.style.display = 'none'; // Esconde o painel ao editar
            editFormWrapper.style.display = 'block';
            document.getElementById('char-doc-id').value = docId;
            document.getElementById('char-name').value = data.name;
            charThumbUrlInput.value = data.image_thumb_url || '';
            charOriginalUrlInput.value = data.image_original_url || '';
            document.getElementById('char-description').value = data.description || '';
            document.getElementById('char-status').value = data.status || 'ativo';
            document.getElementById('char-form-title').textContent = `Editar: ${data.name}`;
            editFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };
        
        function resetAndHideForm() { 
            characterDetailsForm.reset(); 
            editFormWrapper.style.display = 'none'; 
        }
        
        function handleEscKey(event) {
            if (event.key === 'Escape') {
                if (charManagerPanel.style.display === 'flex') charManagerPanel.style.display = 'none';
                else if (fullImageModal.style.display === 'flex') closeFullImageModal();
                else if (relationshipModal.style.display === 'flex') relationshipModal.style.display = 'none';
                else if (characterModal.style.display === 'flex') characterModal.style.display = 'none';
                else if (cropperModal.style.display === 'flex') cropperModal.style.display = 'none';
            }
        }
        
        // --- IN√çCIO: L√ìGICA DO NOVO PAINEL DE GERENCIAMENTO ---
        const createCharacterCard = (character) => {
            const card = document.createElement('div');
            card.className = 'character-card';
            card.innerHTML = `
                <span class="delete-icon" title="Excluir">&times;</span>
                <img src="${character.image_thumb_url || 'https://dummyimage.com/150x150/ccc/000.png&text=?'}" alt="Retrato de ${character.name}">
                <div class="char-name">${character.name}</div>
            `;
            // Clicar no card para editar
            card.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-icon')) return; // N√£o edita se clicou no √≠cone de deletar
                editCharacterDetails(character.id, character);
            });
            // Clicar no √≠cone para deletar
            card.querySelector('.delete-icon').addEventListener('click', async () => {
                if (confirm(`Tem certeza que deseja excluir ${character.name}?`)) {
                    await db.collection("character_details").doc(character.id).delete();
                }
            });
            return card;
        };

        const createAddCard = () => {
            const card = document.createElement('div');
            card.className = 'character-card add-character-card';
            card.innerHTML = `<div class="plus-icon">+</div><div class="char-name">Adicionar</div>`;
            card.addEventListener('click', () => {
                charManagerPanel.style.display = 'none';
                const createForm = document.getElementById('create-character-form');
                createForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
                createForm.querySelector('input').focus();
            });
            return card;
        }

        const filterAndRenderCharacters = () => {
            if (charManagerPanel.style.display !== 'flex') return;
            charGrid.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const charactersAsArray = Object.values(allCharacterDetails);

            const filteredByStatus = charactersAsArray.filter(char => (char.status || 'ativo') === currentStatusFilter);
            const finalList = filteredByStatus.filter(char => char.name.toLowerCase().includes(searchTerm));
            
            finalList.sort((a,b) => a.name.localeCompare(b.name)).forEach(character => {
                charGrid.appendChild(createCharacterCard(character));
            });
            
            if (currentStatusFilter === 'ativo') {
                charGrid.appendChild(createAddCard());
            }
        };

        // --- L√ìGICA PRINCIPAL E EVENT LISTENERS ---

        // Listeners do NOVO PAINEL
        openCharManagerBtn.addEventListener('click', () => {
            charManagerPanel.style.display = 'flex';
            searchInput.value = '';
            filterAndRenderCharacters();
        });
        closePanelBtn.addEventListener('click', () => charManagerPanel.style.display = 'none');
        tabAtivos.addEventListener('click', () => { currentStatusFilter = 'ativo'; tabAtivos.classList.add('active'); tabArquivados.classList.remove('active'); filterAndRenderCharacters(); });
        tabArquivados.addEventListener('click', () => { currentStatusFilter = 'arquivado'; tabArquivados.classList.add('active'); tabAtivos.classList.remove('active'); filterAndRenderCharacters(); });
        searchInput.addEventListener('keyup', filterAndRenderCharacters);
        
        // Listeners do Firebase (carregamento de dados)
        db.collection("character_details").onSnapshot(snapshot => {
            allCharacterDetails = {};
            snapshot.docs.forEach(doc => { allCharacterDetails[doc.id] = {id: doc.id, ...doc.data()}; });
            
            const sortedChars = Object.values(allCharacterDetails).sort((a,b) => a.name.localeCompare(b.name));
            const char1Select = document.getElementById('char1');
            const char2Select = document.getElementById('char2');
            char2Select.innerHTML = '';
            sortedChars.forEach(char => char2Select.innerHTML += `<option value="${char.name}">${char.name}</option>`);
            char1Select.innerHTML = `<option value="${centralCharacter}">${centralCharacter}</option>`;
            
            filterAndRenderCharacters(); // Atualiza o painel em tempo real
            drawRelationshipMap();
        });
        
        db.collection("social_links").onSnapshot(linkSnapshot => { 
            allRelationships = linkSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()})); 
            drawRelationshipMap(); 
        });

        // Listeners dos formul√°rios e intera√ß√µes da p√°gina
        characterMapSelect.addEventListener('change', (e) => {
            centralCharacter = e.target.value;
            document.getElementById('char1').innerHTML = `<option value="${centralCharacter}">${centralCharacter}</option>`;
            drawRelationshipMap();
        });

        document.getElementById('create-character-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const name = document.getElementById('new-char-name').value.trim(); 
            if (name) { 
                await db.collection("character_details").doc(name).set({ name: name, status: 'ativo' }, { merge: true }); 
                e.target.reset(); 
            } 
        });
        
        characterDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const docId = document.getElementById('char-doc-id').value; if (!docId) return;
            const dataToUpdate = {
                name: document.getElementById('char-name').value,
                description: document.getElementById('char-description').value,
                image_thumb_url: charThumbUrlInput.value,
                image_original_url: charOriginalUrlInput.value,
                status: document.getElementById('char-status').value
            };
            await db.collection("character_details").doc(docId).update(dataToUpdate);
            resetAndHideForm();
        });

        cancelCharEditBtn.addEventListener('click', resetAndHideForm);
        
        document.getElementById('social-link-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const data = { 
                char1: document.getElementById('char1').value, 
                char2: document.getElementById('char2').value, 
                description: document.getElementById('relationship-description').value, 
                socialLink: { level: 0, bonuses: {} } 
            }; 
            await db.collection("social_links").add(data); 
            e.target.reset(); 
        });
        
        characterModal.querySelector('.close-button').addEventListener('click', () => { characterModal.style.display = 'none'; });
        relationshipModal.querySelector('.close-button').addEventListener('click', () => { relationshipModal.style.display = 'none'; });
        fullImageModal.querySelector('.close-button').addEventListener('click', closeFullImageModal);
        
        editRelationshipBtn.addEventListener('click', async (e) => {
            const linkId = e.target.dataset.linkId; if (!linkId) return;
            const relationship = allRelationships.find(rel => rel.id === linkId);
            const newDescription = prompt("Editar descri√ß√£o:", relationship.description || "");
            if (newDescription !== null) { 
                await db.collection('social_links').doc(linkId).update({ description: newDescription }); 
                relationship.description = newDescription; 
                showRelationshipModal(linkId); 
            }
        });

        deleteRelationshipBtn.addEventListener('click', async (e) => {
            const linkId = e.target.dataset.linkId; if (!linkId) return;
            if (confirm("Excluir esta rela√ß√£o permanentemente?")) { 
                await db.collection('social_links').doc(linkId).delete(); 
                relationshipModal.style.display = 'none'; 
            }
        });
        
        document.addEventListener('keydown', handleEscKey);

        document.getElementById('char-image-upload').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            originalFileToUpload = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                cropperModal.style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(imageToCrop, { aspectRatio: 1, viewMode: 1, background: false, autoCropArea: 0.8, movable: true, zoomable: true, rotatable: false, scalable: false });
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('save-crop-btn').addEventListener('click', () => {
            if (!cropper || !originalFileToUpload) return;
            const btn = document.getElementById('save-crop-btn');
            btn.textContent = 'Enviando...';
            btn.disabled = true;

            const charName = document.getElementById('char-name').value.trim() || 'personagem';
            const timestamp = Date.now();
            
            const originalFileName = `char_${charName.replace(/\s+/g, '_')}_${timestamp}_original.png`;
            const originalStorageRef = storage.ref(`character_images/${originalFileName}`);
            
            originalStorageRef.put(originalFileToUpload)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(downloadURL => {
                    charOriginalUrlInput.value = downloadURL;
                    
                    cropper.getCroppedCanvas({ width: 256, height: 256 }).toBlob(blob => {
                        const thumbFileName = `char_${charName.replace(/\s+/g, '_')}_${timestamp}_thumb.png`;
                        const thumbStorageRef = storage.ref(`character_images/${thumbFileName}`);
                        
                        thumbStorageRef.put(blob)
                            .then(snapshot => snapshot.ref.getDownloadURL())
                            .then(downloadURL => {
                                charThumbUrlInput.value = downloadURL;
                                alert('Imagens enviadas com sucesso! Clique em "Salvar" para aplicar as mudan√ßas.');
                                cropperModal.style.display = 'none';
                            })
                            .catch(err => console.error("Erro no upload do thumb:", err))
                            .finally(() => {
                                btn.textContent = 'Salvar';
                                btn.disabled = false;
                            });
                    }, 'image/png');
                })
                .catch(error => {
                    console.error("Erro no upload da imagem original: ", error);
                    btn.textContent = 'Salvar';
                    btn.disabled = false;
                });
        });
    </script>
</body>
</html>