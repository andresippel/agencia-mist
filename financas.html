<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Controle Financeiro - Agência MIST</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .balance-table { margin-bottom: 30px; }
        .balance-table th, .balance-table td { text-align: center; }
        .filter-options { margin-bottom: 20px; }
        #transactions-table th, #transactions-table td { text-align: center; }
        #transactions-table .actions-cell { width: 120px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Controle Financeiro</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="form-container">
            <h3>Adicionar Entrada/Saída Manual</h3>
            <form id="finance-form">
                <input type="hidden" id="entry-id">
                <div class="form-group">
                    <label for="char-select">Personagem</label>
                    <select id="char-select" required></select>
                </div>
                <div class="form-group">
                    <label for="amount">Valor</label>
                    <input type="number" id="amount" required>
                </div>
                <div class="form-group">
                    <label for="description">Descrição</label>
                    <input type="text" id="description" required>
                </div>
                <div class="form-group">
                    <label for="type-select">Tipo</label>
                    <select id="type-select" required>
                        <option value="ganho">Ganho</option>
                        <option value="gasto">Gasto</option>
                    </select>
                </div>
                <button type="submit" id="submit-btn">Salvar</button>
                <button type="button" id="cancel-btn" style="display:none;">Cancelar</button>
            </form>
        </div>
        
        <div class="balance-table">
            <h2>Saldos Atuais</h2>
            <table id="balances">
                <thead>
                    <tr>
                        <th>Akane</th>
                        <th>Gemini</th>
                        <th>Tilas</th>
                        <th>Daemian</th>
                        <th>Bart</th>
                    </tr>
                </thead>
                <tbody id="balances-body">
                    <tr>
                        <td id="balance-akane">...</td>
                        <td id="balance-gemini">...</td>
                        <td id="balance-tilas">...</td>
                        <td id="balance-daemian">...</td>
                        <td id="balance-bart">...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="filter-options">
            <div class="form-group">
                <label for="filter-char-select">Filtrar por Personagem:</label>
                <select id="filter-char-select"></select>
            </div>
        </div>
        
        <div class="table-container">
            <h2>Extrato de Transações</h2>
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Personagem</th>
                        <th>Valor</th>
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body">
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
       
        const db = firebase.firestore();

        const financesCollection = db.collection("finances");
        const characters = ["Akane", "Gemini", "Tilas", "Daemian", "Bart"];

        const form = document.getElementById('finance-form');
        const entryIdInput = document.getElementById('entry-id');
        const charSelect = document.getElementById('char-select');
        const amountInput = document.getElementById('amount');
        const descriptionInput = document.getElementById('description');
        const typeSelect = document.getElementById('type-select');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        const transactionsTableBody = document.getElementById('transactions-table-body');
        const balancesBody = document.getElementById('balances-body');
        const filterCharSelect = document.getElementById('filter-char-select');

        // Preenche os selects
        const populateCharacters = (select) => {
            select.innerHTML = '<option value="">Todos</option>';
            characters.forEach(char => {
                const option = document.createElement('option');
                option.value = char;
                option.textContent = char;
                select.appendChild(option);
            });
        };
        populateCharacters(charSelect);
        populateCharacters(filterCharSelect);
        filterCharSelect.value = ""; // Define o valor padrão como 'Todos'

        // Escuta a coleção de finanças para atualizar ambas as tabelas
        financesCollection.orderBy("createdAt", "desc").onSnapshot(snapshot => {
            const allTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // Calcula e atualiza a tabela de saldos
            const balances = {};
            characters.forEach(char => balances[char] = 0);

            allTransactions.forEach(t => {
                if (balances.hasOwnProperty(t.character)) {
                    if (t.type === 'ganho') {
                        balances[t.character] += t.amount;
                    } else if (t.type === 'gasto') {
                        balances[t.character] -= t.amount;
                    }
                }
            });
            characters.forEach(char => {
                document.getElementById(`balance-${char.toLowerCase()}`).textContent = balances[char];
            });

            // Atualiza a tabela de transações com base no filtro
            const filterValue = filterCharSelect.value;
            transactionsTableBody.innerHTML = '';
            const filteredTransactions = filterValue ? allTransactions.filter(t => t.character === filterValue) : allTransactions;

            filteredTransactions.forEach(t => {
                const row = document.createElement('tr');
                const date = new Date(t.createdAt).toLocaleDateString();
                row.innerHTML = `
                    <td>${t.character}</td>
                    <td>${t.amount}</td>
                    <td>${t.description}</td>
                    <td>${date}</td>
                    <td class="actions-cell">
                        <button class="edit-btn">Editar</button>
                        <button class="delete-btn">Excluir</button>
                    </td>
                `;
                row.querySelector('.edit-btn').addEventListener('click', () => editEntry(t.id, t));
                row.querySelector('.delete-btn').addEventListener('click', () => deleteEntry(t.id));
                transactionsTableBody.appendChild(row);
            });
        });

        // Evento de filtro
        filterCharSelect.addEventListener('change', () => {
            // A atualização já é feita pelo onSnapshot, não precisa de lógica extra aqui
        });

        // Funções do formulário e ações (sem alteração)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const entry = {
                character: charSelect.value,
                amount: parseInt(amountInput.value),
                description: descriptionInput.value,
                type: typeSelect.value,
                createdAt: new Date().toISOString()
            };
            const id = entryIdInput.value;
            try {
                if (id) {
                    await financesCollection.doc(id).update(entry);
                } else {
                    await financesCollection.add(entry);
                }
                form.reset();
                entryIdInput.value = '';
                submitBtn.textContent = 'Salvar';
                cancelBtn.style.display = 'none';
            } catch (error) {
                console.error("Erro ao salvar a entrada: ", error);
                alert("Erro ao salvar a entrada. Verifique o console.");
            }
        });

        const editEntry = (id, data) => {
            entryIdInput.value = id;
            charSelect.value = data.character;
            amountInput.value = data.amount;
            descriptionInput.value = data.description;
            typeSelect.value = data.type;
            submitBtn.textContent = 'Atualizar';
            cancelBtn.style.display = 'inline-block';
        };

        const deleteEntry = async (id) => {
            if (confirm("Tem certeza?")) {
                await financesCollection.doc(id).delete();
            }
        };

        cancelBtn.addEventListener('click', () => {
            form.reset();
            entryIdInput.value = '';
            submitBtn.textContent = 'Salvar';
            cancelBtn.style.display = 'none';
        });
    </script>
</body>
</html>