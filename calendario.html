<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Calendário - Agência MIST</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .calendar-container { width: 100%; max-width: 900px; background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        td { cursor: pointer; }
        .has-event { background-color: #f1c40f !important; color: #fff !important; font-weight: bold; position: relative; }
        .has-event::after { content: ''; position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; border-radius: 50%; background-color: #c0392b; }
        #appointment-view li { display: flex; justify-content: space-between; align-items: center; }
        .rpg-today { background-color: #2ecc71 !important; color: #fff !important; font-weight: bold; border: 2px solid #27ae60; }
        .date-setter { display: flex; gap: 10px; align-items: center; padding: 15px; background-color: #f9f9f9; border-radius: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .date-setter select, .date-setter input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calendário de Eventos</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">Página Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="date-setter">
            <label><b>Data Atual do Jogo:</b></label>
            <select id="day-select"></select>
            <select id="month-select"></select>
            <input type="number" id="year-input" value="20" style="width: 80px;">
            <button id="set-date-btn">Definir Data</button>
            <button id="goto-date-btn">Ir para Data Atual</button>
        </div>

        <div class="calendar-container">
            <div class="header">
                <button id="prev-month">&lt; Anterior</button>
                <h2 id="month-year"></h2>
                <button id="next-month">Próximo &gt;</button>
            </div>
            <table>
                <thead><tr><th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>Sáb</th></tr></thead>
                <tbody id="calendar-body"></tbody>
            </table>
        </div>

        <div id="appointment-view" class="calendar-container">
            <h3>Compromissos do Dia</h3>
            <p id="selected-day-info">Clique em um dia para ver os compromissos.</p>
            <ul id="appointment-list"></ul>
            <button id="add-appointment-btn">Adicionar Compromisso</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const db = firebase.firestore();
        const appointmentsCollection = db.collection("rpg-appointments");
        const gameDateRef = db.collection("game_state").doc("current_date");

        // --- Elementos da Página ---
        const monthYearEl=document.getElementById("month-year"),calendarBody=document.getElementById("calendar-body"),prevMonthBtn=document.getElementById("prev-month"),nextMonthBtn=document.getElementById("next-month"),selectedDayInfo=document.getElementById("selected-day-info"),appointmentList=document.getElementById("appointment-list"),addAppointmentBtn=document.getElementById("add-appointment-btn"),daySelect=document.getElementById("day-select"),monthSelect=document.getElementById("month-select"),yearInput=document.getElementById("year-input"),setDateBtn=document.getElementById("set-date-btn"),gotoDateBtn=document.getElementById("goto-date-btn");

        let currentDateForView = new Date();
        let rpgCurrentDate = { day: 1, month: 0, year: 20 };
        let localAppointments = {};
        let selectedDateStr = null;
        const monthNames = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

        // --- LÓGICA DA DATA ATUAL DO JOGO ---
        gameDateRef.onSnapshot((doc) => {
            if (doc.exists) {
                rpgCurrentDate = doc.data();
            } else {
                const today = new Date();
                rpgCurrentDate = { day: today.getDate(), month: today.getMonth(), year: 20 };
                gameDateRef.set(rpgCurrentDate);
            }
            updateDateSelectors();
            
            // --- INÍCIO DA CORREÇÃO ---
            // Usando setFullYear para definir a data corretamente
            const tempDate = new Date(0); // Cria uma data base
            tempDate.setFullYear(rpgCurrentDate.year, rpgCurrentDate.month, 1);
            currentDateForView = tempDate;
            // --- FIM DA CORREÇÃO ---

            renderCalendar();
        });
        
        setDateBtn.addEventListener('click', () => {
            const newDate = { day: parseInt(daySelect.value), month: parseInt(monthSelect.value), year: parseInt(yearInput.value) };
            gameDateRef.set(newDate).then(() => {
                alert(`Data do jogo definida para: ${newDate.day} de ${monthNames[newDate.month]} de ${newDate.year}.`);
            });
        });

        gotoDateBtn.addEventListener('click', () => {
            // --- INÍCIO DA CORREÇÃO ---
            const tempDate = new Date(0);
            tempDate.setFullYear(rpgCurrentDate.year, rpgCurrentDate.month, 1);
            currentDateForView = tempDate;
            // --- FIM DA CORREÇÃO ---
            renderCalendar();
        });

        // --- LÓGICA DO CALENDÁRIO ---
        function renderCalendar() { /* ... (código completo nos blocos abaixo) ... */ }
        function populateDateSelectors() { /* ... */ }
        function updateDateSelectors() { /* ... */ }

        // --- Eventos e Funções de Compromisso ---
        prevMonthBtn.addEventListener('click', () => { currentDateForView.setMonth(currentDateForView.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentDateForView.setMonth(currentDateForView.getMonth() + 1); renderCalendar(); });
        addAppointmentBtn.addEventListener('click', () => { if (!selectedDateStr) return; const newAppointment = prompt(`Adicionar compromisso para ${selectedDateStr.split('-')[2]}/${selectedDateStr.split('-')[1]}/${selectedDateStr.split('-')[0]}:`); if (newAppointment && newAppointment.trim() !== '') { addAppointment(selectedDateStr, newAppointment); } });
        
        async function addAppointment(dateStr, appointmentText) { await appointmentsCollection.add({ dateStr, text: appointmentText }); }
        async function deleteAppointment(docId) { if (confirm("Tem certeza?")) { await appointmentsCollection.doc(docId).delete(); } }
        
        function showAppointments(year, month, day) {
            selectedDateStr = `${year}-${month + 1}-${day}`;
            selectedDayInfo.textContent = `Compromissos para: ${day} de ${monthNames[month]} de ${year}`;
            appointmentList.innerHTML = '';
            const dayAppointments = localAppointments[selectedDateStr] || [];
            if (dayAppointments.length > 0) {
                dayAppointments.forEach(app => {
                    const li = document.createElement('li');
                    li.textContent = app.text;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'X';
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.onclick = () => deleteAppointment(app.id);
                    li.appendChild(deleteBtn);
                    appointmentList.appendChild(li);
                });
            } else { appointmentList.innerHTML = '<li>Nenhum compromisso agendado.</li>'; }
        }

        appointmentsCollection.onSnapshot(snapshot => {
            localAppointments = {};
            snapshot.docs.forEach(doc => {
                const app = doc.data();
                if (!localAppointments[app.dateStr]) localAppointments[app.dateStr] = [];
                localAppointments[app.dateStr].push({ id: doc.id, text: app.text });
            });
            renderCalendar();
        });

        // --- Inicialização e Funções Auxiliares ---
        function populateDateSelectors() {
            monthSelect.innerHTML = ''; daySelect.innerHTML = '';
            monthNames.forEach((name, index) => { const option = document.createElement('option'); option.value = index; option.textContent = name; monthSelect.appendChild(option); });
            for(let i = 1; i <= 31; i++) { const option = document.createElement('option'); option.value = i; option.textContent = i; daySelect.appendChild(option); }
        }
        function updateDateSelectors() { daySelect.value = rpgCurrentDate.day; monthSelect.value = rpgCurrentDate.month; yearInput.value = rpgCurrentDate.year; }
        function renderCalendar() {
            const year = currentDateForView.getFullYear(); const month = currentDateForView.getMonth();
            monthYearEl.textContent = `${monthNames[month]} de ${year}`;
            calendarBody.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let date = 1;
            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');
                    if ((i === 0 && j < firstDayOfMonth) || date > daysInMonth) { cell.classList.add('empty'); }
                    else {
                        const dayNumber = date;
                        if (dayNumber === rpgCurrentDate.day && month === rpgCurrentDate.month && year === rpgCurrentDate.year) { cell.classList.add('rpg-today'); }
                        const fullDateStr = `${year}-${month + 1}-${dayNumber}`;
                        if (localAppointments[fullDateStr]) { cell.classList.add('has-event'); }
                        cell.textContent = dayNumber;
                        cell.addEventListener('click', () => showAppointments(year, month, dayNumber));
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (date > daysInMonth) break;
            }
        }
        populateDateSelectors();
    </script>
</body>
</html>