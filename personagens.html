<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personagens - Ag√™ncia MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        .content-wrapper { display: flex; gap: 20px; margin-top: 20px; }
        .char-list { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 250px; }
        .char-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .char-item:hover { background-color: #f0f0f0; }
        .char-sheet { flex: 3; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* HEADER & GRID PRINCIPAL */
        .statblock-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .statblock-header h1 { margin: 0; font-size: 24px; color: #2c3e50; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .stat-box { text-align: center; }
        .stat-box .label { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #555; }
        .stat-box .value { font-size: 18px; font-weight: bold; color: #000; }
        
        /* GRID DE PER√çCIAS */
        .skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 5px 15px; margin-top: 10px; }
        .skill-row { display: flex; align-items: center; font-size: 0.9em; border-bottom: 1px solid #f9f9f9; padding: 3px 0; }
        .skill-name { flex: 1; margin-left: 8px; color: #333; }
        .skill-bonus { font-weight: bold; width: 30px; text-align: right; }
        
        /* BADGES (U, T, E, M, L) */
        .prof-badge { width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 9px; font-weight: bold; color: white; margin-right: 5px; }
        .prof-u { background-color: #95a5a6; } .prof-t { background-color: #34495e; } .prof-e { background-color: #27ae60; } .prof-m { background-color: #f39c12; } .prof-l { background-color: #8e44ad; }

        /* OUTROS */
        .section-title { background-color: #333; color: #fff; padding: 5px 10px; font-weight: bold; margin-top: 20px; border-radius: 3px; }
        .saves-row { display: flex; gap: 20px; margin: 10px 0; font-weight: bold; justify-content: space-around; }
        .abilities-row { display: flex; justify-content: space-between; margin: 10px 0; border-top: 1px solid #ddd; padding-top: 10px;}
        .import-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .import-box { flex: 1; padding: 15px; background: #e8f4fd; border: 1px dashed #3498db; border-radius: 8px; }
        textarea.json-in { width: 100%; height: 60px; margin-top: 5px; font-family: monospace; font-size: 11px; }

        /* MAGIAS & MODAL */
        .spell-tag { background: #eef; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; border: 1px solid #dde; cursor: pointer; display: inline-flex; gap: 5px; margin: 2px;}
        .spell-tag:hover { background: #dce; border-color: #3498db; }
        .spell-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .spell-card { background: white; width: 500px; max-width: 90%; border-radius: 5px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.5); font-family: sans-serif; display: flex; flex-direction: column; max-height: 80vh; }
        .spell-body { padding: 15px; overflow-y: auto; flex: 1; }
        .spell-editor { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .spell-desc-content { white-space: pre-wrap; line-height: 1.5; color: #333; }
        .nethys-link { color: #3498db; font-size: 0.9em; text-decoration: none; margin-right: 15px;}
        .edit-btn { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 0.8em; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fichas dos Personagens (PF2e)</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">P√°gina Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="import-section">
            <div class="import-box">
                <label><b>Op√ß√£o A: Upload de Arquivo</b></label>
                <input type="file" id="json-file" accept=".json" style="margin-top:5px;">
            </div>
            <div class="import-box">
                <label><b>Op√ß√£o B: Colar JSON</b></label>
                <textarea id="json-textarea" class="json-in" placeholder='Cole o c√≥digo do Pathbuilder aqui...'></textarea>
                <button id="btn-import-text" style="margin-top:5px; cursor:pointer;">Importar</button>
            </div>
        </div>

        <div class="content-wrapper">
            <aside class="char-list">
                <h3>Personagens</h3>
                <div id="list-container">Carregando...</div>
            </aside>
            <main class="char-sheet" id="sheet-display">
                <p style="text-align: center; color: #777; margin-top: 50px;">Selecione um personagem.</p>
            </main>
        </div>
    </div>

    <div id="spell-modal" class="spell-modal-overlay">
        <div class="spell-card">
            <div style="background:#191919; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <h2 id="modal-spell-name" style="margin:0;">Magia</h2>
                <span id="modal-spell-action" style="background:#333; padding:2px 8px; border-radius:4px; font-size:0.8em;"></span>
            </div>
            
            <div class="spell-body">
                <div id="modal-spell-desc" class="spell-desc-content">Carregando...</div>
                
                <div style="margin-top:15px; font-size:0.9em; border-top:1px solid #eee; padding-top:10px;">
                     <a href="#" id="modal-nethys-link" target="_blank" class="nethys-link">üîç Buscar no Nethys</a>
                     <button onclick="toggleEdit()" class="edit-btn">‚úé Editar/Corrigir Descri√ß√£o</button>
                </div>

                <div id="spell-editor" class="spell-editor">
                    <label style="font-weight:bold; font-size:0.8em;">Cole a descri√ß√£o aqui (Salve para usar sempre):</label>
                    <textarea id="editor-text" style="width:100%; height:150px; margin-top:5px; font-family:inherit;"></textarea>
                    <button onclick="saveSpellDesc()" style="background:#27ae60; color:white; border:none; padding:8px; width:100%; margin-top:5px; cursor:pointer; font-weight:bold;">Salvar na Biblioteca</button>
                </div>
            </div>
            
            <button onclick="document.getElementById('spell-modal').style.display='none'" style="width:100%; padding:15px; border:none; background:#eee; cursor:pointer; font-weight:bold; color:#333;">Fechar</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const charsCollection = db.collection("personagens");
        const spellsCollection = db.collection("biblioteca_magias"); // NOVA COLE√á√ÉO
        
        const fileInput = document.getElementById('json-file');
        const textArea = document.getElementById('json-textarea');
        const btnImportText = document.getElementById('btn-import-text');
        const listContainer = document.getElementById('list-container');
        const sheetDisplay = document.getElementById('sheet-display');
        
        // Elementos do Modal
        const spellModal = document.getElementById('spell-modal');
        const mName = document.getElementById('modal-spell-name');
        const mAct = document.getElementById('modal-spell-action');
        const mDesc = document.getElementById('modal-spell-desc');
        const mEditor = document.getElementById('spell-editor');
        const mEditText = document.getElementById('editor-text');
        const mLink = document.getElementById('modal-nethys-link');
        
        let currentSpellName = "";

        // --- SISTEMA DE MAGIA INTELIGENTE ---
        window.openSpellModal = async (name, action) => {
            currentSpellName = name;
            mName.innerText = name;
            mAct.innerText = action || "?";
            mDesc.innerHTML = "<i>Buscando descri√ß√£o...</i>";
            mEditor.style.display = 'none';
            mEditText.value = "";
            
            // Link do Nethys
            mLink.href = `https://2e.aonprd.com/Search.aspx?q=${name.replace(/\s+/g, '+')}`;
            
            spellModal.style.display = 'flex';

            try {
                // Tenta buscar no banco de dados
                const doc = await spellsCollection.doc(name).get();
                if (doc.exists && doc.data().desc) {
                    mDesc.innerHTML = doc.data().desc.replace(/\n/g, '<br>');
                } else {
                    mDesc.innerHTML = "<em>Descri√ß√£o n√£o encontrada na biblioteca.</em><br>Clique em <b>'Buscar no Nethys'</b>, copie o texto e clique em <b>'Editar'</b> para salvar aqui para sempre.";
                }
            } catch (e) {
                console.error(e);
                mDesc.innerText = "Erro ao buscar magia.";
            }
        };

        window.toggleEdit = () => {
            mEditor.style.display = mEditor.style.display === 'none' ? 'block' : 'none';
            // Se o editor abriu e o texto estava vazio, tenta preencher com o atual (sem HTML)
            if (mEditor.style.display === 'block') {
                 mEditText.value = mDesc.innerText.includes("Descri√ß√£o n√£o encontrada") ? "" : mDesc.innerText;
                 mEditText.focus();
            }
        };

        window.saveSpellDesc = async () => {
            const text = mEditText.value;
            if (!text) return;
            
            try {
                // Salva na cole√ß√£o separada para n√£o poluir a ficha do personagem
                await spellsCollection.doc(currentSpellName).set({
                    name: currentSpellName,
                    desc: text,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                mDesc.innerHTML = text.replace(/\n/g, '<br>');
                mEditor.style.display = 'none';
                alert("Magia salva na biblioteca do grupo!");
            } catch (e) {
                alert("Erro ao salvar: " + e.message);
            }
        };

        // ... [RESTANTE DO C√ìDIGO DE IMPORTA√á√ÉO IGUAL AO ANTERIOR] ...
        // (Vou repetir aqui para garantir que voc√™ tenha o arquivo completo funcionando)
        
        const standardSkills = [
            { id: 'acrobatics', name: 'Acrobatics', attr: 'dex' }, { id: 'arcana', name: 'Arcana', attr: 'int' },
            { id: 'athletics', name: 'Athletics', attr: 'str' }, { id: 'crafting', name: 'Crafting', attr: 'int' },
            { id: 'deception', name: 'Deception', attr: 'cha' }, { id: 'diplomacy', name: 'Diplomacy', attr: 'cha' },
            { id: 'intimidation', name: 'Intimidation', attr: 'cha' }, { id: 'medicine', name: 'Medicine', attr: 'wis' },
            { id: 'nature', name: 'Nature', attr: 'wis' }, { id: 'occultism', name: 'Occultism', attr: 'int' },
            { id: 'performance', name: 'Performance', attr: 'cha' }, { id: 'religion', name: 'Religion', attr: 'wis' },
            { id: 'society', name: 'Society', attr: 'int' }, { id: 'stealth', name: 'Stealth', attr: 'dex' },
            { id: 'survival', name: 'Survival', attr: 'wis' }, { id: 'thievery', name: 'Thievery', attr: 'dex' }
        ];

        async function importCharData(jsonData) {
            try {
                if (!jsonData.build) throw new Error("JSON inv√°lido.");
                const rawData = extractPathbuilderData(jsonData.build);
                const charData = JSON.parse(JSON.stringify(rawData));
                await charsCollection.doc(charData.nome).set(charData);
                alert(`Personagem ${charData.nome} atualizado!`);
                fileInput.value = ''; textArea.value = '';
            } catch (error) { console.error(error); alert("Erro: " + error.message); }
        }

        function extractPathbuilderData(build) {
            const safeNum = (v) => (v && !isNaN(v)) ? Number(v) : 0;
            const safeStr = (v) => (v) ? String(v) : "";
            const level = safeNum(build.level);
            const getAbilVal = (n) => { const val = build.abilities[n] || build.abilities[n.charAt(0).toUpperCase() + n.slice(1)]; return safeNum(val); };
            const getAbilMod = (n) => Math.floor((getAbilVal(n) - 10) / 2);

            let hp = safeNum(build.attributes.hp);
            if (hp === 0) {
                 const conMod = getAbilMod('con');
                 hp = safeNum(build.attributes.ancestryhp) + ((safeNum(build.attributes.classhp) + conMod) * level) + safeNum(build.attributes.bonushp);
            }

            const processedSkills = [];
            const profs = build.proficiencies || {};
            standardSkills.forEach(skill => {
                const profValue = safeNum(profs[skill.id]); 
                const total = (profValue > 0 ? (profValue + level) : 0) + getAbilMod(skill.attr);
                processedSkills.push({ name: skill.name, total: total, prof: profValue });
            });
            const excludedKeys = ['fortitude', 'reflex', 'will', 'perception', 'classDC', ...standardSkills.map(s => s.id)];
            Object.keys(profs).forEach(key => {
                if (!excludedKeys.includes(key) && !key.toLowerCase().includes("weapon") && !key.toLowerCase().includes("armor") && !key.toLowerCase().includes("unarmored")) {
                    const profValue = safeNum(profs[key]);
                    const total = (profValue > 0 ? (profValue + level) : 0) + getAbilMod('int');
                    const name = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
                    processedSkills.push({ name: name.includes("Lore") ? name : `Lore: ${name}`, total: total, prof: profValue });
                }
            });
            processedSkills.sort((a, b) => a.name.localeCompare(b.name));

            let classDC = { val: 0 };
            if (build.proficiencies.classDC) {
                const mods = [getAbilMod('str'), getAbilMod('dex'), getAbilMod('int'), getAbilMod('wis'), getAbilMod('cha')];
                classDC.val = 10 + level + safeNum(build.proficiencies.classDC) + Math.max(...mods);
            }

            const weapons = (build.weapons || []).map(w => {
                const nameLower = (w.display || w.name || "").toLowerCase();
                const traits = (w.traits || []).map(t => String(t).toLowerCase());
                const isRanged = traits.some(t => t.includes('range')) || nameLower.includes('crossbow') || nameLower.includes('bow') || nameLower.includes('gun') || nameLower.includes('sling');
                const finesseNames = ['rapier', 'dagger', 'shortsword', 'whip', 'elven curve blade', 'aldori dueling sword'];
                const isFinesse = traits.includes('finesse') || finesseNames.some(n => nameLower.includes(n));
                const isPropulsive = traits.includes('propulsive'); const isThrown = traits.includes('thrown');

                let atkAttr = 'str';
                if (isRanged) { atkAttr = 'dex'; } 
                else if (isFinesse) { if (getAbilVal('dex') > getAbilVal('str')) atkAttr = 'dex'; }

                let profBonus = 0; if (w.prof && build.proficiencies[w.prof]) profBonus = build.proficiencies[w.prof]; else profBonus = 2;
                const pot = safeNum(w.pot);
                const atk = level + profBonus + getAbilMod(atkAttr) + pot;

                let dmgBonus = 0;
                if (!isRanged || isThrown) { dmgBonus += getAbilMod('str'); } 
                else if (isPropulsive) { dmgBonus += Math.floor(getAbilMod('str') / 2); }
                if (profBonus >= 4) dmgBonus += 2; if (profBonus >= 6) dmgBonus += 1;
                if (safeStr(build.class).toLowerCase().includes("thaumaturge")) { dmgBonus += 2; }

                const die = w.die || "d4"; const diceCount = w.str ? 2 : 1; 
                const traitsFormatted = w.traits ? `(${w.traits.join(', ')})` : '';
                const extraText = `${pot?`+${pot} `:''}${w.str?'Striking ':''}${traitsFormatted}`;

                return { nome: w.display || w.name, ataque: `+${atk}`, dano: `${diceCount}${die} + ${dmgBonus}`, extras: extraText };
            });

            const spells = [];
            const mapAction = (act) => {
                if(!act) return "?"; const a=String(act).toLowerCase();
                if(a.includes("reaction")) return "‚Ü∂"; if(a.includes("3")) return "‚óÜ‚óÜ‚óÜ"; if(a.includes("2")) return "‚óÜ‚óÜ"; if(a.includes("1")) return "‚óÜ"; return "?";
            };
            let sStats = { dc: 0, attack: 0, ability: "" };
            if (build.spellCasters) {
                build.spellCasters.forEach(caster => {
                    const abil = caster.ability || "cha"; const prof = safeNum(caster.proficiency); const mod = getAbilMod(abil);
                    const dc = 10 + level + prof + mod; const atk = level + prof + mod;
                    if (dc > sStats.dc) sStats = { dc: dc, attack: atk, ability: abil.toUpperCase() };

                    if (caster.spells) {
                        caster.spells.forEach(obj => {
                            const list = (obj.list || []).map(s => {
                                let sName = (typeof s === 'string') ? s : (s.name || "Magia");
                                // AQUI: Removemos a depend√™ncia do gloss√°rio fixo. Usamos o nome e a√ß√£o, a descri√ß√£o vem do Firebase depois.
                                let sAct = (typeof s === 'object' && s.actions) ? mapAction(s.actions) : "?";
                                return { nome: sName, acao: sAct };
                            });
                            if (list.length > 0) spells.push({ nivel: obj.spellLevel===0?"Cantrips":`N√≠vel ${obj.spellLevel}`, magias: list });
                        });
                    }
                });
            }

            const calcSave = (k, ab) => { const p = safeNum(build.proficiencies[k]); return (p>0 ? p+level : 0) + getAbilMod(ab); };

            return {
                nome: safeStr(build.name)||"Sem Nome", nivel: level||1, classe: safeStr(build.class), ancestralidade: safeStr(build.ancestry),
                atributos: { for: getAbilVal('str'), des: getAbilVal('dex'), con: getAbilVal('con'), int: getAbilVal('int'), sab: getAbilVal('wis'), car: getAbilVal('cha') },
                hp: hp, ca: safeNum(build.acTotal?.acTotal || build.acTotal)||10,
                percepcao: calcSave('perception','wis'), classDC: classDC,
                saves: { fort: calcSave('fortitude','con'), ref: calcSave('reflex','dex'), vont: calcSave('will','wis') },
                velocidade: safeNum(build.speed)||25, skills: processedSkills,
                armas: weapons, magias: spells, spellStats: sStats, pets: []
            };
        }

        // --- RENDER ---
        fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload=(ev)=>{try{importCharData(JSON.parse(ev.target.result));}catch(e){alert("Erro JSON");}}; r.readAsText(f); });
        btnImportText.addEventListener('click', () => { try{ importCharData(JSON.parse(textArea.value.trim())); }catch(e){alert("JSON inv√°lido.");} });
        charsCollection.onSnapshot(snap => { listContainer.innerHTML=''; snap.forEach(doc => { const d = document.createElement('div'); d.className='char-item'; d.textContent=doc.data().nome; d.onclick=()=>renderSheet(doc.data()); listContainer.appendChild(d); }); });

        function renderSheet(char) {
            const mod = (v) => Math.floor((v-10)/2); const fmt = (v) => v>=0?`+${v}`:v; const fmtSave = (v) => `CD ${10+v} (${fmt(v)})`;
            const getBadge = (prof) => { let l="U", c="prof-u"; if(prof>=2){l="T";c="prof-t";} if(prof>=4){l="E";c="prof-e";} if(prof>=6){l="M";c="prof-m";} if(prof>=8){l="L";c="prof-l";} return `<div class="prof-badge ${c}">${l}</div>`; };
            const skillsHtml = char.skills.map(s => `<div class="skill-row">${getBadge(s.prof)}<div class="skill-bonus">${fmt(s.total)}</div><div class="skill-name">${s.name}</div></div>`).join('');
            
            let spellStatsHtml = '';
            if (char.spellStats && char.spellStats.dc > 0) {
                spellStatsHtml = `<div style="background:#e8f6f3; padding:10px; border-radius:5px; margin: 10px 0; border: 1px solid #1abc9c; display:flex; justify-content:space-around; text-align:center;">
                    <div><div style="font-size:0.8em; text-transform:uppercase; color:#16a085;">Spell DC</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.dc}</div></div>
                    <div><div style="font-size:0.8em; text-transform:uppercase; color:#16a085;">Atk</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">+${char.spellStats.attack}</div></div>
                    <div><div style="font-size:0.8em; text-transform:uppercase; color:#16a085;">Attr</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.ability}</div></div>
                </div>`;
            }

            const spellsHtml = (char.magias||[]).map(n => `<div><strong>${n.nivel}</strong>: ${n.magias.map(m=>`<span class="spell-tag" onclick="openSpellModal('${m.nome}', '${m.acao}')">${m.nome} ${m.acao}</span>`).join('')}</div>`).join('');
            const weaponsHtml = (char.armas||[]).map(a => `<li style="border-bottom:1px solid #eee; margin-bottom:5px;"><b>${a.nome}</b> ${a.ataque} (${a.dano}) <br><small>${a.extras}</small></li>`).join('');

            sheetDisplay.innerHTML = `
                <div class="statblock-header"><h1>${char.nome}</h1><div class="sub">N√≠vel ${char.nivel} ${char.ancestralidade} ${char.classe}</div></div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="label">Class DC</div><div class="value" style="color:#d35400;">${char.classDC.val}</div></div>
                    <div class="stat-box"><div class="label">Percep√ß√£o</div><div class="value">+${char.percepcao}</div></div>
                    <div class="stat-box"><div class="label">PV</div><div class="value" style="color:#c0392b;">${char.hp}</div></div>
                    <div class="stat-box"><div class="label">CA</div><div class="value" style="color:#2980b9;">${char.ca}</div></div>
                </div>
                <div class="abilities-row">
                    <div class="stat-box"><div class="label">FOR</div><div class="value">${char.atributos.for} (${fmt(mod(char.atributos.for))})</div></div>
                    <div class="stat-box"><div class="label">DES</div><div class="value">${char.atributos.des} (${fmt(mod(char.atributos.des))})</div></div>
                    <div class="stat-box"><div class="label">CON</div><div class="value">${char.atributos.con} (${fmt(mod(char.atributos.con))})</div></div>
                    <div class="stat-box"><div class="label">INT</div><div class="value">${char.atributos.int} (${fmt(mod(char.atributos.int))})</div></div>
                    <div class="stat-box"><div class="label">SAB</div><div class="value">${char.atributos.sab} (${fmt(mod(char.atributos.sab))})</div></div>
                    <div class="stat-box"><div class="label">CAR</div><div class="value">${char.atributos.car} (${fmt(mod(char.atributos.car))})</div></div>
                </div>
                <div class="section-title">Per√≠cias</div><div class="skills-grid">${skillsHtml}</div>
                <div class="section-title">Defesas</div><div class="saves-row"><span>Fort: ${fmtSave(char.saves.fort)}</span><span>Ref: ${fmtSave(char.saves.ref)}</span><span>Vont: ${fmtSave(char.saves.vont)}</span></div>
                <div class="section-title">Ofensiva</div><ul>${weaponsHtml}</ul>
                <div class="section-title">Magias</div>${spellStatsHtml}${spellsHtml}
            `;
        }
    });
    </script>
</body>
</html>