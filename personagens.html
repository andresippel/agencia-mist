<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Personagens - Ag√™ncia MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- ESTILOS GERAIS --- */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: sans-serif; background-color: #f4f6f7; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        header h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        header nav { display: flex; gap: 15px; }
        header nav a { text-decoration: none; color: #3498db; font-weight: bold; font-size: 0.9rem; }

        /* Import Section */
        .import-section { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .import-box { flex: 1; min-width: 280px; padding: 15px; background: #e8f4fd; border: 1px dashed #3498db; border-radius: 8px; }
        .import-box label { display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50; }
        input[type="file"], input[type="text"], textarea { width: 100%; margin-bottom: 8px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        textarea.json-in { height: 60px; font-family: monospace; font-size: 11px; }
        button#btn-import-text { width: 100%; padding: 10px; background-color: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Layout Wrapper */
        .content-wrapper { display: flex; gap: 20px; align-items: flex-start; }
        
        /* Lista de Personagens */
        .char-list { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 200px; max-width: 250px; }
        .char-list h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px;}
        .char-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; font-weight: 500; color: #333; }
        .char-item:hover { background-color: #f0f0f0; }

        /* Ficha */
        .char-sheet { flex: 3; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; }

        /* Mobile */
        @media (max-width: 768px) {
            header { flex-direction: column; text-align: center; }
            header nav { width: 100%; justify-content: center; margin-top: 10px; }
            .content-wrapper { flex-direction: column; }
            .char-list { max-width: 100%; width: 100%; overflow-x: auto; display: flex; gap: 10px; padding: 10px; align-items: center; white-space: nowrap; }
            .char-list h3 { display: none; }
            .char-item { flex: 0 0 auto; background: #f8f9fa; border: 1px solid #ddd; border-radius: 20px; padding: 8px 15px; font-size: 0.9rem; }
            .stat-grid { gap: 5px; }
            .stat-box { min-width: 45%; }
            .skills-grid { grid-template-columns: 1fr 1fr; }
        }

        /* Internos da Ficha */
        .statblock-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        .statblock-header h1 { margin: 0; font-size: 1.8rem; color: #2c3e50; }
        
        /* Stats Grid */
        .stat-grid { display: flex; justify-content: space-around; align-items: center; background: #f4f6f7; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0; flex-wrap: wrap; gap: 15px; }
        .stat-box { text-align: center; flex: 1; min-width: 80px; }
        .stat-box .label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: #7f8c8d; margin-bottom: 2px;}
        .stat-box .value { font-size: 1.2rem; font-weight: bold; color: #2c3e50; }
        .stat-box.main-stat .value { font-size: 1.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* Tactics Box */
        .tactics-box { background-color: #eaf2f8; border-left: 5px solid #3498db; padding: 15px; margin-bottom: 20px; border-radius: 4px; font-size: 0.95em; line-height: 1.6; }
        .tactics-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #cbdceb; padding-bottom: 5px; }
        .tactics-title { font-weight: bold; color: #2980b9; text-transform: uppercase; font-size: 0.85em; }
        .btn-edit-tactics { background: none; border: none; color: #7f8c8d; cursor: pointer; font-size: 0.8em; text-decoration: underline; }
        .tactics-content ul { padding-left: 25px; margin: 10px 0; }
        .tactics-editor { display: none !important; margin-top: 10px; } /* Force hide on load */
        .tactics-editor.is-visible { display: block !important; }
        .tactics-textarea { width: 100%; height: 200px; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .btn-save-tactics { width: 100%; background: #27ae60; color: white; border: none; padding: 10px; margin-top: 5px; border-radius: 4px; font-weight: bold; }

        /* Detalhes */
        .abilities-row { display: flex; justify-content: space-between; margin: 10px 0; border-top: 1px solid #ddd; padding-top: 10px; flex-wrap: wrap; gap: 10px; }
        .skills-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 5px 10px; margin-top: 10px; }
        .skill-row { display: flex; align-items: center; font-size: 0.9em; border-bottom: 1px solid #f9f9f9; padding: 3px 0; }
        .skill-name { flex: 1; margin-left: 8px; color: #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .skill-bonus { font-weight: bold; width: 30px; text-align: right; }
        .prof-badge { width: 18px; height: 18px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 9px; font-weight: bold; color: white; margin-right: 5px; flex-shrink: 0; }
        .prof-u { background-color: #95a5a6; } .prof-t { background-color: #34495e; } .prof-e { background-color: #27ae60; } .prof-m { background-color: #f39c12; } .prof-l { background-color: #8e44ad; }
        .saves-row { display: flex; gap: 10px; margin: 10px 0; font-weight: bold; justify-content: space-around; flex-wrap: wrap; }
        .section-title { background-color: #333; color: #fff; padding: 5px 10px; font-weight: bold; margin-top: 20px; border-radius: 3px; font-size: 0.9rem; }

        /* Pets & Modais */
        .pet-block { background: #fdfefe; border: 1px solid #ddd; border-left: 4px solid #27ae60; padding: 10px; margin-top: 10px; border-radius: 4px; }
        .pet-header { font-weight: bold; color: #27ae60; display: flex; justify-content: space-between; }
        .spell-tag { background: #eef; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; border: 1px solid #dde; cursor: pointer; display: inline-block; margin: 2px; }
        .spell-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .spell-card { background: white; width: 90%; max-width: 500px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; max-height: 80vh; }
        .spell-body { padding: 15px; overflow-y: auto; flex: 1; }
        .pb-link { display:block; text-align:center; background:#d4af37; color:white; padding:12px; border-radius:5px; text-decoration:none; font-weight:bold; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ag√™ncia MIST</h1>
            <nav>
                <a href="index.html">In√≠cio</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="import-section">
            <div class="import-box">
                <label>üìÇ JSON do Personagem</label>
                <input type="file" id="json-file" accept=".json">
            </div>
            <div class="import-box">
                <label>üìù Colar JSON ou Link</label>
                <input type="text" id="pathbuilder-id-input" placeholder="Link do Pathbuilder (Opcional)">
                <textarea id="json-textarea" class="json-in" placeholder='Cole o JSON aqui...'></textarea>
                <button id="btn-import-text">IMPORTAR / ATUALIZAR</button>
            </div>
        </div>

        <div class="content-wrapper">
            <aside class="char-list">
                <h3>Personagens</h3>
                <div id="list-container">Carregando...</div>
            </aside>
            
            <main class="char-sheet" id="sheet-display">
                <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">üßô‚Äç‚ôÇÔ∏è</div>
                    <p>Selecione um personagem para ver a ficha.</p>
                </div>
            </main>
        </div>
    </div>

    <div id="spell-modal" class="spell-modal-overlay">
        <div class="spell-card">
            <div style="background:#2c3e50; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center;">
                <h3 id="modal-spell-name" style="margin:0; font-size:1.1rem;">Magia</h3>
                <span id="modal-spell-action" style="background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px; font-size:0.8em;"></span>
            </div>
            <div class="spell-body">
                <div id="modal-spell-desc" style="line-height:1.5; color:#333;"></div>
                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; display:flex; flex-direction:column; gap:10px;">
                     <a href="#" id="modal-nethys-link" target="_blank" style="color:#3498db; text-decoration:none; font-weight:bold;">üîç Ver no Archives of Nethys</a>
                     <button onclick="toggleEdit()" class="edit-btn">‚úé Editar Descri√ß√£o</button>
                </div>
                <div id="spell-editor" style="display:none; margin-top:10px;">
                    <textarea id="editor-text" style="width:100%; height:120px; padding:8px; border:1px solid #ccc; border-radius:4px;"></textarea>
                    <button onclick="saveSpellDesc()" style="width:100%; background:#27ae60; color:white; border:none; padding:10px; margin-top:5px; border-radius:4px; font-weight:bold;">Salvar</button>
                </div>
            </div>
            <button onclick="document.getElementById('spell-modal').style.display='none'" style="width:100%; padding:15px; border:none; background:#f1f1f1; color:#333; font-weight:bold;">FECHAR</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const charsCollection = db.collection("personagens");
        const spellsCollection = db.collection("biblioteca_magias");
        
        const fileInput = document.getElementById('json-file');
        const textArea = document.getElementById('json-textarea');
        const pathInput = document.getElementById('pathbuilder-id-input');
        const btnImportText = document.getElementById('btn-import-text');
        const listContainer = document.getElementById('list-container');
        const sheetDisplay = document.getElementById('sheet-display');
        
        // Elementos Modal
        const spellModal = document.getElementById('spell-modal');
        const mName = document.getElementById('modal-spell-name');
        const mAct = document.getElementById('modal-spell-action');
        const mDesc = document.getElementById('modal-spell-desc');
        const mEditor = document.getElementById('spell-editor');
        const mEditText = document.getElementById('editor-text');
        const mLink = document.getElementById('modal-nethys-link');
        let currentSpellName = "";
        let currentCharName = "";
        let currentRawTactics = ""; 

        // --- T√ÅTICAS ---
        window.toggleTacticsEdit = () => {
            const editor = document.getElementById('tactics-editor');
            const display = document.getElementById('tactics-content');
            const btn = document.getElementById('btn-edit-tactics');
            const txtArea = document.getElementById('tactics-textarea');
            
            if (editor.classList.contains('is-visible')) {
                editor.classList.remove('is-visible');
                display.style.display = 'block';
                btn.innerText = "‚úé Editar T√°ticas";
            } else {
                editor.classList.add('is-visible');
                display.style.display = 'none';
                btn.innerText = "Cancelar";
                txtArea.value = currentRawTactics || "";
            }
        };

        window.saveTactics = async () => {
            const newText = document.getElementById('tactics-textarea').value;
            const display = document.getElementById('tactics-content');
            try {
                await charsCollection.doc(currentCharName).update({ tacticsText: newText });
                currentRawTactics = newText;
                display.innerHTML = newText ? marked.parse(newText) : "<i>Nenhuma anota√ß√£o. Clique em editar.</i>";
                window.toggleTacticsEdit(); 
            } catch (error) { alert("Erro ao salvar: " + error.message); }
        };

        btnImportText.addEventListener('click', async () => {
            const jsonText = textArea.value.trim();
            const linkText = pathInput.value.trim();
            if (!jsonText && linkText) {
                if (!currentCharName) { return alert("‚ö†Ô∏è Selecione um personagem primeiro."); }
                let pbId = linkText; if (pbId.includes("build=")) pbId = pbId.split("build=")[1];
                try { await charsCollection.doc(currentCharName).update({ pathbuilderId: pbId }); alert(`‚úÖ Link atualizado!`); pathInput.value = ''; renderSheet(await (await charsCollection.doc(currentCharName).get()).data()); } catch (e) { alert("Erro: " + e.message); }
                return;
            }
            if (jsonText) { try { await importCharData(JSON.parse(jsonText)); } catch(e) { alert("JSON Inv√°lido: " + e.message); } } else { alert("Cole o JSON ou Link."); }
        });

        async function importCharData(jsonData) {
            if (!jsonData.build) throw new Error("Formato inv√°lido.");
            const rawData = extractPathbuilderData(jsonData.build);
            const charData = JSON.parse(JSON.stringify(rawData));
            let pbLink = pathInput.value.trim(); if (pbLink.includes("build=")) pbLink = pbLink.split("build=")[1]; if (pbLink) charData.pathbuilderId = pbLink;
            await charsCollection.doc(charData.nome).set(charData, { merge: true });
            alert(`‚úÖ ${charData.nome} atualizado!`);
            fileInput.value = ''; textArea.value = ''; pathInput.value = '';
        }

        // --- EXTRA√á√ÉO E FILTRO DE PER√çCIAS (CORRIGIDO) ---
        function extractPathbuilderData(build) {
            const safeNum = (v) => (v && !isNaN(v)) ? Number(v) : 0;
            const safeStr = (v) => (v) ? String(v) : "";
            const level = safeNum(build.level);
            const getAbilVal = (n) => { const val = build.abilities[n] || build.abilities[n.charAt(0).toUpperCase() + n.slice(1)]; return safeNum(val); };
            const getAbilMod = (n) => Math.floor((getAbilVal(n) - 10) / 2);

            let hp = safeNum(build.attributes.hp);
            if (hp === 0) { const conMod = getAbilMod('con'); hp = safeNum(build.attributes.ancestryhp) + ((safeNum(build.attributes.classhp) + conMod) * level) + safeNum(build.attributes.bonushp); }

            const petsList = [];
            const processPet = (p, tipo) => ({ nome: p.name||"Pet", tipo: tipo, hp: safeNum(p.attributes?.hp)||(level*5), ca: safeNum(p.ac)||(10+level+2), atributos: { for: safeNum(p.abilities?.str), des: safeNum(p.abilities?.dex), con: safeNum(p.abilities?.con), int: safeNum(p.abilities?.int), sab: safeNum(p.abilities?.wis), car: safeNum(p.abilities?.cha) } });
            if(build.pets) build.pets.forEach(p=>petsList.push(processPet(p, p.type||"Comp.")));
            if(build.familiars) build.familiars.forEach(f=>petsList.push(processPet(f, "Fam.")));

            const weapons = (build.weapons || []).map(w => {
                const nameLower = (w.display || w.name || "").toLowerCase();
                const traits = (w.traits || []).map(t => String(t).toLowerCase());
                const isRanged = traits.some(t => t.includes('range')) || nameLower.includes('crossbow') || nameLower.includes('bow') || nameLower.includes('gun') || nameLower.includes('sling');
                const finesseNames = ['rapier', 'dagger', 'shortsword', 'whip', 'elven curve blade', 'aldori dueling sword'];
                const isFinesse = traits.includes('finesse') || finesseNames.some(n => nameLower.includes(n));
                const isPropulsive = traits.includes('propulsive'); const isThrown = traits.includes('thrown');
                let atkAttr = 'str'; if (isRanged) { atkAttr = 'dex'; } else if (isFinesse) { if (getAbilVal('dex') > getAbilVal('str')) atkAttr = 'dex'; }
                let profBonus = 0; if (w.prof && build.proficiencies[w.prof]) profBonus = build.proficiencies[w.prof]; else profBonus = 2;
                const pot = safeNum(w.pot); const atk = level + profBonus + getAbilMod(atkAttr) + pot;
                let dmgBonus = 0; if (!isRanged || isThrown) { dmgBonus += getAbilMod('str'); } else if (isPropulsive) { dmgBonus += Math.floor(getAbilMod('str') / 2); }
                if (profBonus >= 4) dmgBonus += 2; if (profBonus >= 6) dmgBonus += 1;
                if (safeStr(build.class).toLowerCase().includes("thaumaturge")) { dmgBonus += 2; }
                const die = w.die || "d4"; const diceCount = w.str ? 2 : 1; const traitsFormatted = w.traits ? `(${w.traits.join(', ')})` : '';
                return { nome: w.display || w.name, ataque: `+${atk}`, dano: `${diceCount}${die} + ${dmgBonus}`, extras: `${pot?`+${pot} `:''}${w.str?'Striking ':''}${traitsFormatted}` };
            });

            let maxSpellDC = 0;
            const spells = [];
            const mapAction = (act) => { if(!act) return "?"; const a=String(act).toLowerCase(); if(a.includes("reaction")) return "‚Ü∂"; if(a.includes("3")) return "‚óÜ‚óÜ‚óÜ"; if(a.includes("2")) return "‚óÜ‚óÜ"; if(a.includes("1")) return "‚óÜ"; return "?"; };
            let sStats = { dc: 0, attack: 0, ability: "" };
            if (build.spellCasters) {
                build.spellCasters.forEach(caster => {
                    const abil = caster.ability || "cha"; const prof = safeNum(caster.proficiency); const mod = getAbilMod(abil);
                    const dc = 10 + level + prof + mod; const atk = level + prof + mod; 
                    if (dc > sStats.dc) sStats = { dc: dc, attack: atk, ability: abil.toUpperCase() };
                    if (dc > maxSpellDC) maxSpellDC = dc;
                    if (caster.spells) caster.spells.forEach(obj => { const list = (obj.list || []).map(s => ({ nome: typeof s === 'string' ? s : s.name, acao: typeof s === 'object' ? mapAction(s.actions) : "?" })); if(list.length>0) spells.push({ nivel: obj.spellLevel===0?"Cantrips":`N√≠vel ${obj.spellLevel}`, magias: list }); });
                });
            }

            // --- FILTRO DE PER√çCIAS (ATUALIZADO) ---
            const standardSkills = [
                {id:'acrobatics',name:'Acrobatics',attr:'dex'},{id:'arcana',name:'Arcana',attr:'int'},{id:'athletics',name:'Athletics',attr:'str'},{id:'crafting',name:'Crafting',attr:'int'},{id:'deception',name:'Deception',attr:'cha'},{id:'diplomacy',name:'Diplomacy',attr:'cha'},{id:'intimidation',name:'Intimidation',attr:'cha'},{id:'medicine',name:'Medicine',attr:'wis'},{id:'nature',name:'Nature',attr:'wis'},{id:'occultism',name:'Occultism',attr:'int'},{id:'performance',name:'Performance',attr:'cha'},{id:'religion',name:'Religion',attr:'wis'},{id:'society',name:'Society',attr:'int'},{id:'stealth',name:'Stealth',attr:'dex'},{id:'survival',name:'Survival',attr:'wis'},{id:'thievery',name:'Thievery',attr:'dex'}
            ];
            const processedSkills = []; 
            const profs = build.proficiencies || {};
            
            // 1. Adiciona as 16 per√≠cias padr√£o
            standardSkills.forEach(skill => { 
                const profValue = safeNum(profs[skill.id]); 
                const total = (profValue > 0 ? (profValue + level) : 0) + getAbilMod(skill.attr); 
                processedSkills.push({ name: skill.name, total: total, prof: profValue }); 
            });

            // 2. Filtra Lores (Exclui armas, armaduras, spellcasting e palavras proibidas)
            const excludedExactKeys = ['fortitude', 'reflex', 'will', 'perception', 'classDC', ...standardSkills.map(s => s.id)];
            // Lista de palavras que indicam que N√ÉO √© uma per√≠cia
            const forbiddenSubstrings = ['weapon', 'armor', 'shield', 'unarmored', 'simple', 'martial', 'advanced', 'unarmed', 'casting', 'spell', 'light', 'medium', 'heavy'];

            Object.keys(profs).forEach(key => { 
                const keyLower = key.toLowerCase();
                // Se est√° na lista exata de exclus√£o, pula
                if (excludedExactKeys.includes(key)) return;
                // Se cont√©m qualquer palavra proibida, pula
                if (forbiddenSubstrings.some(badWord => keyLower.includes(badWord))) return;

                const profValue = safeNum(profs[key]); 
                const total = (profValue > 0 ? (profValue + level) : 0) + getAbilMod('int'); 
                let name = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim(); 
                if (!name.includes("Lore")) name = `Lore: ${name}`;
                
                processedSkills.push({ name: name, total: total, prof: profValue }); 
            });
            processedSkills.sort((a, b) => a.name.localeCompare(b.name));

            const calcSave = (k, ab) => { const p = safeNum(build.proficiencies[k]); return (p>0 ? p+level : 0) + getAbilMod(ab); };
            let finalClassDC = safeNum(build.attributes.classDC);
            if (finalClassDC === 0 && build.proficiencies.classDC) { const mods = [getAbilMod('str'), getAbilMod('dex'), getAbilMod('int'), getAbilMod('wis'), getAbilMod('cha')]; finalClassDC = 10 + level + safeNum(build.proficiencies.classDC) + Math.max(...mods); }
            if (maxSpellDC > finalClassDC) finalClassDC = maxSpellDC; if (finalClassDC === 0) finalClassDC = 10 + level;
            return {
                nome: safeStr(build.name)||"Sem Nome", nivel: level||1, classe: safeStr(build.class), ancestralidade: safeStr(build.ancestry),
                atributos: { for: getAbilVal('str'), des: getAbilVal('dex'), con: getAbilVal('con'), int: getAbilVal('int'), sab: getAbilVal('wis'), car: getAbilVal('cha') },
                hp: hp, ca: safeNum(build.acTotal?.acTotal || build.acTotal)||10, percepcao: calcSave('perception','wis'), classDC: { val: finalClassDC }, 
                saves: { fort: calcSave('fortitude','con'), ref: calcSave('reflex','dex'), vont: calcSave('will','wis') },
                velocidade: safeNum(build.speed)||25, skills: processedSkills, armas: weapons, magias: spells, spellStats: sStats, pets: petsList
            };
        }

        function renderSheet(char) {
            currentCharName = char.nome; 
            currentRawTactics = char.tacticsText || ""; 
            const tacticsHtmlContent = currentRawTactics ? marked.parse(currentRawTactics) : "<i>Nenhuma anota√ß√£o. Clique em editar.</i>";
            const mod = (v) => Math.floor((v-10)/2); const fmt = (v) => v>=0?`+${v}`:v; const fmtSave = (v) => `CD ${10+v} (${fmt(v)})`;
            let pbLinkHtml = ""; if (char.pathbuilderId) { pbLinkHtml = `<a href="https://pathbuilder2e.com/launch.html?build=${char.pathbuilderId}" target="_blank" class="pb-link">üìú Abrir Ficha Original no Pathbuilder</a>`; }
            let statusGridHtml = `<div class="stat-grid"><div class="stat-box main-stat"><div class="label">Pontos de Vida</div><div class="value" style="color:#c0392b;">‚ù§Ô∏è ${char.hp}</div></div><div class="stat-box main-stat"><div class="label">Classe de Armadura</div><div class="value" style="color:#2980b9;">üõ°Ô∏è ${char.ca}</div></div><div class="stat-box"><div class="label">Iniciativa (Perc)</div><div class="value">üëÅÔ∏è +${char.percepcao}</div></div><div class="stat-box"><div class="label">Velocidade</div><div class="value">ü¶∂ ${char.velocidade} ft</div></div><div class="stat-box"><div class="label">Class DC</div><div class="value">üéì ${char.classDC.val}</div></div></div>`;
            let tacticsHtml = `<div class="tactics-box"><div class="tactics-header"><span class="tactics-title">üß† Resumo T√°tico & Anota√ß√µes</span><button id="btn-edit-tactics" class="btn-edit-tactics" onclick="toggleTacticsEdit()">‚úé Editar T√°ticas</button></div><div id="tactics-content" class="tactics-content">${tacticsHtmlContent}</div><div id="tactics-editor" class="tactics-editor" style="display:none;"><textarea id="tactics-textarea" class="tactics-textarea"></textarea><button class="btn-save-tactics" onclick="saveTactics()">Salvar Altera√ß√µes</button></div></div>`;
            let petsHtml = ""; if (char.pets && char.pets.length > 0) { petsHtml = `<div class="section-title">Companheiros & Familiares</div>` + char.pets.map(p => `<div class="pet-block"><div class="pet-header"><span>${p.nome}</span> <span>${p.tipo}</span></div><div class="pet-stats"><span>‚ù§Ô∏è <b>HP:</b> ${p.hp}</span><span>üõ°Ô∏è <b>CA:</b> ${p.ca}</span></div><div class="abilities-row" style="font-size:0.8em; margin-top:5px; border-top:1px dashed #ccc;"><div>S: ${fmt(mod(p.atributos.for))}</div><div>D: ${fmt(mod(p.atributos.des))}</div><div>C: ${fmt(mod(p.atributos.con))}</div><div>I: ${fmt(mod(p.atributos.int))}</div><div>S: ${fmt(mod(p.atributos.sab))}</div><div>C: ${fmt(mod(p.atributos.car))}</div></div></div>`).join(''); }
            const getBadge = (prof) => { let l="U", c="prof-u"; if(prof>=2){l="T";c="prof-t";} if(prof>=4){l="E";c="prof-e";} if(prof>=6){l="M";c="prof-m";} if(prof>=8){l="L";c="prof-l";} return `<div class="prof-badge ${c}">${l}</div>`; };
            const skillsHtml = char.skills.map(s => `<div class="skill-row">${getBadge(s.prof)}<div class="skill-bonus">${fmt(s.total)}</div><div class="skill-name">${s.name}</div></div>`).join('');
            const spellsHtml = (char.magias||[]).map(n => `<div><strong>${n.nivel}</strong>: ${n.magias.map(m=>`<span class="spell-tag" onclick="openSpellModal('${m.nome}', '${m.acao}')">${m.nome} ${m.acao}</span>`).join('')}</div>`).join('');
            const weaponsHtml = (char.armas||[]).map(a => `<li style="border-bottom:1px solid #eee; margin-bottom:5px;"><b>${a.nome}</b> ${a.ataque} (${a.dano}) <br><small>${a.extras}</small></li>`).join('');
            let spellStatsHtml = ""; if (char.spellStats && char.spellStats.dc > 0) spellStatsHtml = `<div style="background:#e8f6f3; padding:10px; border-radius:5px; margin: 10px 0; border: 1px solid #1abc9c; display:flex; justify-content:space-around; text-align:center; font-size:0.9em;"><div><div style="text-transform:uppercase; color:#16a085;">DC</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.dc}</div></div><div><div style="text-transform:uppercase; color:#16a085;">Atk</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">+${char.spellStats.attack}</div></div><div><div style="text-transform:uppercase; color:#16a085;">Attr</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.ability}</div></div></div>`;

            sheetDisplay.innerHTML = `
                <div class="statblock-header"><h1>${char.nome}</h1><div class="sub">N√≠vel ${char.nivel} ${char.ancestralidade} ${char.classe}</div></div>
                ${pbLinkHtml} ${tacticsHtml} ${statusGridHtml}
                <div class="abilities-row"><div class="stat-box"><div class="label">FOR</div><div class="value">${char.atributos.for} (${fmt(mod(char.atributos.for))})</div></div><div class="stat-box"><div class="label">DES</div><div class="value">${char.atributos.des} (${fmt(mod(char.atributos.des))})</div></div><div class="stat-box"><div class="label">CON</div><div class="value">${char.atributos.con} (${fmt(mod(char.atributos.con))})</div></div><div class="stat-box"><div class="label">INT</div><div class="value">${char.atributos.int} (${fmt(mod(char.atributos.int))})</div></div><div class="stat-box"><div class="label">SAB</div><div class="value">${char.atributos.sab} (${fmt(mod(char.atributos.sab))})</div></div><div class="stat-box"><div class="label">CAR</div><div class="value">${char.atributos.car} (${fmt(mod(char.atributos.car))})</div></div></div>
                <div class="section-title">Per√≠cias</div><div class="skills-grid">${skillsHtml}</div>
                <div class="section-title">Defesas</div><div class="saves-row"><span>Fort: ${fmtSave(char.saves.fort)}</span><span>Ref: ${fmtSave(char.saves.ref)}</span><span>Vont: ${fmtSave(char.saves.vont)}</span></div>
                <div class="section-title">Ofensiva</div><ul>${weaponsHtml}</ul>
                <div class="section-title">Magias</div>${spellStatsHtml}${spellsHtml}${petsHtml}
            `;
        }

        window.openSpellModal = async (name, action) => { currentSpellName=name; mName.innerText=name; mAct.innerText=action||"?"; mDesc.innerHTML="Buscando..."; mLink.href=`https://2e.aonprd.com/Search.aspx?q=${name}`; spellModal.style.display='flex'; try{const doc=await spellsCollection.doc(name).get();if(doc.exists)mDesc.innerHTML=doc.data().desc.replace(/\n/g,'<br>');}catch(e){} };
        window.toggleEdit = () => { mEditor.style.display=mEditor.style.display==='none'?'block':'none'; if(mEditor.style.display==='block')mEditText.value=mDesc.innerText; };
        window.saveSpellDesc = async () => { await spellsCollection.doc(currentSpellName).set({name:currentSpellName, desc:mEditText.value},{merge:true}); mDesc.innerHTML=mEditText.value; mEditor.style.display='none'; };
        fileInput.addEventListener('change', (e)=>{const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=(ev)=>{try{importCharData(JSON.parse(ev.target.result));}catch(e){}}; r.readAsText(f);});
        
        charsCollection.onSnapshot(snap=>{listContainer.innerHTML=''; snap.forEach(doc=>{const d=document.createElement('div'); d.className='char-item'; d.textContent=doc.data().nome; d.onclick=()=>renderSheet(doc.data()); listContainer.appendChild(d);});});
    });
    </script>
</body>
</html>