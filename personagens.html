<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personagens - Ag√™ncia MIST</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="auth-check.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        /* Estilos Gerais */
        .content-wrapper { display: flex; gap: 20px; margin-top: 20px; }
        .char-list { flex: 1; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 250px; }
        .char-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .char-item:hover { background-color: #f0f0f0; }
        .char-sheet { flex: 3; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Statblock */
        .statblock-header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 15px; }
        .statblock-header h1 { margin: 0; font-size: 24px; color: #2c3e50; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 5px; }
        .stat-box { text-align: center; }
        .stat-box .label { font-size: 12px; font-weight: bold; text-transform: uppercase; color: #555; }
        .stat-box .value { font-size: 18px; font-weight: bold; color: #000; }
        .section-title { background-color: #333; color: #fff; padding: 5px 10px; font-weight: bold; margin-top: 20px; border-radius: 3px; }
        .saves-row { display: flex; gap: 20px; margin: 10px 0; font-weight: bold; justify-content: space-around; }
        .abilities-row { display: flex; justify-content: space-between; margin: 10px 0; border-top: 1px solid #ddd; padding-top: 10px;}
        
        /* Magias e Interatividade */
        .spell-tag {
            background: #eef; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.9em; 
            border: 1px solid #dde; 
            cursor: pointer; 
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .spell-tag:hover { background: #dce; border-color: #bda; transform: translateY(-1px); }
        .action-icon { font-family: "Segoe UI Symbol", sans-serif; font-weight: bold; color: #d35400; }

        /* Import Area */
        .import-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .import-box { flex: 1; padding: 15px; background: #e8f4fd; border: 1px dashed #3498db; border-radius: 8px; }
        textarea { width: 100%; height: 60px; margin-top: 5px; font-family: monospace; font-size: 11px; }

        /* MODAL DE MAGIA (Estilo Pathfinder) */
        .spell-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
        }
        .spell-card {
            background: white; width: 500px; max-width: 90%; border-radius: 5px; overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); font-family: sans-serif;
        }
        .spell-header {
            background: #191919; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;
        }
        .spell-header h2 { margin: 0; font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .spell-level { background: #444; padding: 2px 6px; font-size: 0.7em; border-radius: 3px; }
        .spell-traits { padding: 10px 15px; background: #ddd; display: flex; gap: 5px; flex-wrap: wrap; }
        .trait { background: #5e0000; color: white; padding: 2px 8px; font-size: 0.8em; text-transform: uppercase; font-weight: bold; border: 1px solid #d4af37; }
        .spell-body { padding: 15px; line-height: 1.5; color: #333; max-height: 60vh; overflow-y: auto; }
        .spell-stats-row { display: flex; gap: 15px; margin-bottom: 10px; font-weight: bold; font-size: 0.9em; }
        .stat-pill { background: #eee; padding: 3px 6px; border-radius: 3px; border: 1px solid #ccc; }
        .nethys-btn {
            display: block; width: 100%; text-align: center; padding: 10px; background: #2c3e50; color: white;
            text-decoration: none; font-weight: bold; margin-top: 15px; border-radius: 4px;
        }
        .nethys-btn:hover { background: #34495e; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Fichas dos Personagens (PF2e)</h1>
            <nav>
                <a href="index.html" style="margin-right: 20px;">P√°gina Inicial</a>
                <a href="#" onclick="logout()">Sair</a>
            </nav>
        </header>

        <div class="import-section">
            <div class="import-box">
                <label><b>Op√ß√£o A: Upload de Arquivo</b></label>
                <input type="file" id="json-file" accept=".json" style="margin-top:5px;">
            </div>
            <div class="import-box">
                <label><b>Op√ß√£o B: Colar JSON (View JSON)</b></label>
                <textarea id="json-textarea" placeholder='Cole o c√≥digo aqui...'></textarea>
                <button id="btn-import-text" style="margin-top:5px; cursor:pointer;">Importar</button>
            </div>
        </div>

        <div class="content-wrapper">
            <aside class="char-list">
                <h3>Personagens</h3>
                <div id="list-container">Carregando...</div>
            </aside>

            <main class="char-sheet" id="sheet-display">
                <p style="text-align: center; color: #777; margin-top: 50px;">Selecione um personagem.</p>
            </main>
        </div>
    </div>

    <div id="spell-modal" class="spell-modal-overlay">
        <div class="spell-card">
            <div class="spell-header">
                <h2 id="modal-spell-name">Ignition <span id="modal-spell-action" style="font-size:0.8em;">‚óÜ‚óÜ</span></h2>
                <span id="modal-spell-level" class="spell-level">Cantrip 1</span>
            </div>
            <div id="modal-spell-traits" class="spell-traits">
                </div>
            <div class="spell-body">
                <div class="spell-stats-row" id="modal-spell-stats">
                    </div>
                <div id="modal-spell-desc">
                    </div>
                <a href="#" id="modal-nethys-link" target="_blank" class="nethys-btn">Ver regras completas no Archives of Nethys</a>
                <button onclick="document.getElementById('spell-modal').style.display='none'" style="margin-top:5px; width:100%; padding:8px; cursor:pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const charsCollection = db.collection("personagens");
        
        const fileInput = document.getElementById('json-file');
        const textArea = document.getElementById('json-textarea');
        const btnImportText = document.getElementById('btn-import-text');
        const listContainer = document.getElementById('list-container');
        const sheetDisplay = document.getElementById('sheet-display');
        
        // Elementos do Modal
        const spellModal = document.getElementById('spell-modal');
        const mName = document.getElementById('modal-spell-name');
        const mLevel = document.getElementById('modal-spell-level');
        const mTraits = document.getElementById('modal-spell-traits');
        const mStats = document.getElementById('modal-spell-stats');
        const mDesc = document.getElementById('modal-spell-desc');
        const mLink = document.getElementById('modal-nethys-link');

        // --- GLOSS√ÅRIO DE MAGIAS (ADICIONE MAIS AQUI) ---
        // Como o Pathbuilder n√£o exporta texto, n√≥s definimos aqui.
        const spellLibrary = {
            "Ignition": {
                name: "Ignition",
                action: "‚óÜ‚óÜ",
                traits: ["Attack", "Cantrip", "Concentrate", "Fire", "Manipulate"],
                range: "30 feet",
                target: "1 creature",
                defense: "AC",
                desc: "You snap your fingers and point at a target, which begins to smolder. Make a spell attack roll against the target's AC, dealing fire damage equal to 1d4 + your spellcasting ability modifier.<br><br><b>Melee:</b> If the target is within your melee reach, you can choose to make a melee spell attack with the flame instead of a ranged spell attack, which increases the damage die to d6.",
                heightened: "+1 (1d4)"
            },
            "Shield": {
                name: "Shield",
                action: "‚óÜ",
                traits: ["Cantrip", "Force"],
                range: "Personal",
                defense: "Hardness 5",
                desc: "You raise a magical shield of force. This counts as using the Raise a Shield action, giving you a +1 circumstance bonus to AC until the start of your next turn, but it doesn't require a hand to use.<br><br>You can use the Shield Block reaction with this magic shield. The shield has Hardness 5. After you use Shield Block, the spell ends and you can't cast it again for 10 minutes."
            },
            "Electric Arc": {
                name: "Electric Arc",
                action: "‚óÜ‚óÜ",
                traits: ["Cantrip", "Electricity", "Manipulate"],
                range: "30 feet",
                target: "1 or 2 creatures",
                defense: "Reflex",
                desc: "An arc of lightning leaps from one target to another. You deal electricity damage equal to 1d4 + your spellcasting ability modifier."
            },
            "Heal": {
                name: "Heal",
                action: "‚óÜ a ‚óÜ‚óÜ‚óÜ",
                traits: ["Healing", "Positive", "Vitality"],
                desc: "You channel positive energy to heal the living or damage the undead. <br><b>‚óÜ (1 Action):</b> Touch range, heals 1d8. <br><b>‚óÜ‚óÜ (2 Actions):</b> Ranged 30ft, heals 1d8 + 8. <br><b>‚óÜ‚óÜ‚óÜ (3 Actions):</b> 30ft emanation, heals 1d8 to all living creatures."
            }
        };

        // --- FUN√á√ÉO DE ABERTURA DO MODAL ---
        window.openSpellModal = (spellName, spellLevel) => {
            const data = spellLibrary[spellName] || { 
                name: spellName, 
                action: "?", 
                traits: ["Magia"], 
                desc: "Descri√ß√£o n√£o encontrada no gloss√°rio local. Clique abaixo para ver no site oficial." 
            };

            mName.innerHTML = `${data.name} <span style="font-size:0.7em; color:#f39c12; margin-left:10px;">${data.action}</span>`;
            mLevel.innerText = spellLevel;
            
            mTraits.innerHTML = data.traits.map(t => `<span class="trait">${t}</span>`).join('');
            
            let statsHtml = "";
            if(data.range) statsHtml += `<span class="stat-pill">üìè ${data.range}</span>`;
            if(data.target) statsHtml += `<span class="stat-pill">üéØ ${data.target}</span>`;
            if(data.defense) statsHtml += `<span class="stat-pill">üõ°Ô∏è ${data.defense}</span>`;
            mStats.innerHTML = statsHtml;

            mDesc.innerHTML = data.desc;
            
            // Link para Nethys (Busca Segura)
            const nethysQuery = spellName.replace(/\s+/g, '+'); // Troca espa√ßo por +
            // Ignition √© Remaster, ent√£o usamos a busca geral que redireciona bem
            mLink.href = `https://2e.aonprd.com/Search.aspx?q=${nethysQuery}`;
            
            spellModal.style.display = 'flex';
        };

        // Fecha modal ao clicar fora
        spellModal.addEventListener('click', (e) => {
            if (e.target === spellModal) spellModal.style.display = 'none';
        });

        // --- IMPORTA√á√ÉO ---
        async function importCharData(jsonData) {
            try {
                if (!jsonData.build) throw new Error("JSON inv√°lido.");
                const rawData = extractPathbuilderData(jsonData.build);
                const charData = JSON.parse(JSON.stringify(rawData));
                await charsCollection.doc(charData.nome).set(charData);
                alert(`Personagem ${charData.nome} atualizado!`);
                fileInput.value = ''; textArea.value = '';
            } catch (error) { console.error(error); alert("Erro: " + error.message); }
        }

        // --- EXTRA√á√ÉO ---
        function extractPathbuilderData(build) {
            const safeNum = (val) => (val && !isNaN(val)) ? Number(val) : 0;
            const safeStr = (val) => (val) ? String(val) : "";
            const level = safeNum(build.level);
            const getAbilVal = (n) => safeNum(build.abilities[n]);
            const getAbilMod = (n) => Math.floor((getAbilVal(n) - 10) / 2);

            // HP
            let hp = safeNum(build.attributes.hp);
            if (hp === 0) {
                 const conMod = getAbilMod('con');
                 hp = safeNum(build.attributes.ancestryhp) + ((safeNum(build.attributes.classhp) + conMod) * level) + safeNum(build.attributes.bonushp);
            }

            // Armas
            const weapons = (build.weapons || []).map(w => {
                let atkAttr = 'str';
                if (w.traits && (w.traits.includes('Finesse') || w.traits.includes('Ranged'))) {
                    if (getAbilVal('dex') > getAbilVal('str')) atkAttr = 'dex';
                }
                let prof = 2; 
                if (w.prof && build.proficiencies[w.prof]) prof = build.proficiencies[w.prof];
                const pot = safeNum(w.pot);
                const atk = level + prof + getAbilMod(atkAttr) + pot;
                
                let dmg = 0;
                if (!w.traits || !w.traits.includes('Ranged')) dmg += getAbilMod('str');
                if (prof >= 4) dmg += 2; if (prof >= 6) dmg += 1;

                return {
                    nome: w.display || w.name || "Arma",
                    ataque: `+${atk}`,
                    dano: `${w.str?'2':'1'}${w.die||''} + ${dmg}`,
                    extras: `${pot?`+${pot} `:''}${w.str?'Striking ':''}${w.traits?`(${w.traits.join(', ')})`:''}`
                };
            });

            // Magias
            const spells = [];
            let sStats = { dc: 0, attack: 0, ability: "" };

            // Tradutor de A√ß√µes do Pathbuilder para √çcone
            const mapAction = (act) => {
                if (!act) return "?";
                const a = String(act).toLowerCase();
                if (a.includes("reaction")) return "‚Ü∂";
                if (a.includes("free")) return "‚óá";
                if (a.includes("3") || a.includes("three")) return "‚óÜ‚óÜ‚óÜ";
                if (a.includes("2") || a.includes("two")) return "‚óÜ‚óÜ";
                if (a.includes("1") || a.includes("one")) return "‚óÜ";
                return "?";
            };

            if (build.spellCasters) {
                build.spellCasters.forEach(caster => {
                    const abil = caster.ability || "cha";
                    const prof = safeNum(caster.proficiency);
                    const mod = getAbilMod(abil);
                    const dc = 10 + level + prof + mod;
                    if (dc > sStats.dc) sStats = { dc: dc, attack: level+prof+mod, ability: abil.toUpperCase() };

                    if (caster.spells) {
                        caster.spells.forEach(obj => {
                            const l = obj.spellLevel;
                            const list = (obj.list || []).map(s => {
                                // L√ìGICA DE UNIFICA√á√ÉO
                                // 1. Se o JSON der a a√ß√£o, usa.
                                // 2. Se n√£o der, tenta pegar do nosso spellLibrary
                                // 3. Se n√£o tiver, fica "?"
                                
                                let sName = (typeof s === 'string') ? s : (s.name || "Magia");
                                let sAct = (typeof s === 'object' && s.actions) ? mapAction(s.actions) : null;
                                
                                // Se o JSON n√£o deu a√ß√£o (veio null ou "?"), busca na biblioteca
                                if (!sAct || sAct === "?") {
                                    if (spellLibrary[sName]) {
                                        sAct = spellLibrary[sName].action;
                                    } else {
                                        sAct = ""; // Deixa vazio se n√£o souber
                                    }
                                }

                                return { nome: sName, acao: sAct };
                            });
                            if (list.length > 0) spells.push({ nivel: l===0?"Cantrips":`N√≠vel ${l}`, magias: list });
                        });
                    }
                });
            }

            // Saves
            const calcSave = (k, ab) => {
                const p = safeNum(build.proficiencies[k]);
                return (p>0 ? p+level : 0) + getAbilMod(ab);
            };

            // Pets
            const pets = [];
            const procPet = (p, t) => ({
                nome: p.name||"Pet", tipo: t, hp: safeNum(p.attributes?.hp)||(level*5), ca: safeNum(p.ac)||10,
                atributos: { for: safeNum(p.abilities?.str), des: safeNum(p.abilities?.dex), con: safeNum(p.abilities?.con), int: safeNum(p.abilities?.int), sab: safeNum(p.abilities?.wis), car: safeNum(p.abilities?.cha) }
            });
            if(build.pets) build.pets.forEach(p=>pets.push(procPet(p, p.type||"Comp.")));
            if(build.familiars) build.familiars.forEach(f=>pets.push(procPet(f, "Fam.")));

            return {
                nome: safeStr(build.name)||"Sem Nome", nivel: level||1, classe: safeStr(build.class), ancestralidade: safeStr(build.ancestry),
                atributos: { for: getAbilVal('str'), des: getAbilVal('dex'), con: getAbilVal('con'), int: getAbilVal('int'), sab: getAbilVal('wis'), car: getAbilVal('cha') },
                hp: hp, ca: safeNum(build.acTotal?.acTotal || build.acTotal)||10,
                percepcao: calcSave('perception','wis'),
                saves: { fort: calcSave('fortitude','con'), ref: calcSave('reflex','dex'), vont: calcSave('will','wis') },
                velocidade: safeNum(build.speed)||25,
                pericias: build.proficiencies ? Object.keys(build.proficiencies).filter(k=>!['fortitude','reflex','will','perception','classDC'].includes(k) && build.proficiencies[k]>0).slice(0,10) : [],
                armas: weapons, magias: spells, spellStats: sStats, pets: pets
            };
        }

        fileInput.addEventListener('change', (e) => {
            const f = e.target.files[0]; if(!f)return;
            const r = new FileReader(); r.onload=(ev)=>{try{importCharData(JSON.parse(ev.target.result));}catch(e){alert("Erro JSON");}}; r.readAsText(f);
        });
        btnImportText.addEventListener('click', () => {
            try{ importCharData(JSON.parse(textArea.value.trim())); }catch(e){alert("JSON inv√°lido.");}
        });

        charsCollection.onSnapshot(snap => {
            listContainer.innerHTML='';
            snap.forEach(doc => {
                const d = document.createElement('div'); d.className='char-item'; d.textContent=doc.data().nome;
                d.onclick=()=>renderSheet(doc.data()); listContainer.appendChild(d);
            });
        });

        function renderSheet(char) {
            const mod = (v) => Math.floor((v-10)/2); const fmt = (v) => v>=0?`+${v}`:v;
            const fmtSave = (v) => `CD ${10+v} (${fmt(v)})`;

            let spellStatsHtml = '';
            if (char.spellStats && char.spellStats.dc > 0) {
                spellStatsHtml = `<div style="background:#e8f6f3; padding:10px; border-radius:5px; margin: 10px 0; border: 1px solid #1abc9c; display:flex; justify-content:space-around; text-align:center;">
                    <div><div style="font-size:0.8em; color:#16a085;">DC</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.dc}</div></div>
                    <div><div style="font-size:0.8em; color:#16a085;">Atk</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">+${char.spellStats.attack}</div></div>
                    <div><div style="font-size:0.8em; color:#16a085;">Attr</div><div style="font-size:1.4em; font-weight:bold; color:#0e6251;">${char.spellStats.ability}</div></div>
                </div>`;
            }

            let magiasHtml = '';
            if (char.magias && char.magias.length > 0) {
                magiasHtml = `<div class="section-title">Livro de Magias</div>` + spellStatsHtml;
                char.magias.forEach(n => {
                    magiasHtml += `<div style="margin-top: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                        <strong style="color: #444; display:block; margin-bottom:3px;">${n.nivel}</strong> 
                        <div style="display:flex; flex-wrap:wrap; gap: 8px;">
                            ${n.magias.map(m => `
                                <span class="spell-tag" onclick="openSpellModal('${m.nome}', '${n.nivel}')">
                                    ${m.nome} <span class="action-icon">${m.acao}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>`;
                });
            }

            let armasHtml = '<p style="color:#777;">Sem armas.</p>';
            if (char.armas.length>0) {
                armasHtml = `<ul style="padding-left:0; list-style:none;">${char.armas.map(a=>`
                    <li style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <div style="font-weight:bold; font-size:1.1em; color:#c0392b;">${a.nome} <span style="color:#333;">${a.ataque}</span></div>
                        <div style="font-size:0.9em;"><b>Dano:</b> ${a.dano} <span style="color:#777;">${a.extras}</span></div>
                    </li>`).join('')}</ul>`;
            }

            let petsHtml = '';
            if (char.pets.length > 0) {
                petsHtml = `<div class="section-title">Pets</div>` + char.pets.map(p => `
                    <div style="background:#f0f0f0; padding:10px; margin-bottom:5px; border-left:4px solid #333;">
                        <b>${p.nome}</b> (${p.tipo}) - PV: ${p.hp}, CA: ${p.ca}
                    </div>`).join('');
            }

            sheetDisplay.innerHTML = `
                <div class="statblock-header"><h1>${char.nome}</h1><div class="sub">N√≠vel ${char.nivel} ${char.ancestralidade} ${char.classe}</div></div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="label">PV</div><div class="value" style="color:#c0392b;">${char.hp}</div></div>
                    <div class="stat-box"><div class="label">CA</div><div class="value" style="color:#2980b9;">${char.ca}</div></div>
                    <div class="stat-box"><div class="label">Vel</div><div class="value">${char.velocidade}ft</div></div>
                    <div class="stat-box"><div class="label">Perc</div><div class="value">+${char.percepcao}</div></div>
                </div>
                <div class="abilities-row">
                    <div class="stat-box"><div class="label">FOR</div><div class="value">${char.atributos.for} (${fmt(mod(char.atributos.for))})</div></div>
                    <div class="stat-box"><div class="label">DES</div><div class="value">${char.atributos.des} (${fmt(mod(char.atributos.des))})</div></div>
                    <div class="stat-box"><div class="label">CON</div><div class="value">${char.atributos.con} (${fmt(mod(char.atributos.con))})</div></div>
                    <div class="stat-box"><div class="label">INT</div><div class="value">${char.atributos.int} (${fmt(mod(char.atributos.int))})</div></div>
                    <div class="stat-box"><div class="label">SAB</div><div class="value">${char.atributos.sab} (${fmt(mod(char.atributos.sab))})</div></div>
                    <div class="stat-box"><div class="label">CAR</div><div class="value">${char.atributos.car} (${fmt(mod(char.atributos.car))})</div></div>
                </div>
                <div class="section-title">Defesas</div>
                <div class="saves-row">
                    <div class="stat-box"><div class="label">Fortitude</div><div class="value">${fmtSave(char.saves.fort)}</div></div>
                    <div class="stat-box"><div class="label">Reflexos</div><div class="value">${fmtSave(char.saves.ref)}</div></div>
                    <div class="stat-box"><div class="label">Vontade</div><div class="value">${fmtSave(char.saves.vont)}</div></div>
                </div>
                <div class="section-title">Ofensiva</div>${armasHtml}
                <p><b>Per√≠cias:</b> <span style="text-transform: capitalize;">${char.pericias ? char.pericias.join(', ').replace(/_/g, ' ') : ''}</span></p>
                ${magiasHtml} ${petsHtml}
            `;
        }
    });
    </script>
</body>
</html>