<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agência MIST - Portal da Campanha</title>

    <meta name="theme-color" content="#8B0000">
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        .home-header {
            position: relative;
            text-align: center;
        }
        #auth-status-container {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 0.9em;
            z-index: 10;
        }
        .home-header img { max-width: 150px; margin-bottom: 10px; }
        .home-header h1 { margin-top: 0; }
        .welcome-text { text-align: center; font-size: 1.1em; color: #555; margin-bottom: 40px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 40px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
        .dashboard-widget { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .dashboard-widget h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .dashboard-widget ul { list-style-type: none; padding: 0; margin: 0; }
        .dashboard-widget li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .mission-title { font-weight: bold; }
        .balance-item { display: flex; justify-content: space-between; }
        .home-footer img { max-width: 100%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .home-footer p { margin-top: 20px; font-size: 1.1em; color: #333; }

        #today-info-container {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- ESTILOS DO ÁLBUM DE FOTOS --- */

        #character-album-section {
            padding: 40px 20px;
            margin-top: 40px;
            background-color: #f8f9fa; /* Um fundo suave para destacar a seção */
            border-radius: 8px;
            text-align: center;
        }

        #character-album-section h2 {
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        #character-album-section p {
            margin-bottom: 30px;
            color: #6c757d;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .photo-grid img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 3px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .photo-grid img:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }


        /* --- ESTILOS DO LIGHTBOX (VISUALIZADOR) --- */

        .lightbox-modal {
            display: none; /* Começa escondido */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #lightbox-image {
            max-width: 100%;
            max-height: 80vh; /* Deixa espaço para a legenda */
            border-radius: 5px;
        }

        .lightbox-close-button {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .lightbox-close-button:hover {
            color: #bbb;
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 30px;
            cursor: pointer;
            padding: 16px;
            user-select: none; /* Impede que o texto seja selecionado */
            background-color: rgba(0,0,0,0.3);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }

        #lightbox-caption-container {
            text-align: center;
            color: #ccc;
            padding: 15px 0;
            width: 100%;
            max-width: 800px;
        }

        #lightbox-counter {
            font-size: 0.9em;
            color: #999;
        }

        #lightbox-caption {
            margin-top: 5px;
            font-size: 1.1em;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="home-header">
            <div id="auth-status-container"></div>
            <img src="logo.png" alt="Logo da Agência MIST">
            <h1>Portal de Acesso da Agência MIST</h1>
        </header>

        <main>
            <p class="welcome-text">Bem-vindo, Agente. Consulte os arquivos e recursos da MIST (Monitoramento, Investigação e Soluções Táticas) através dos módulos de acesso abaixo.</p>
            
            <div id="today-info-container">
                <h3>Carregando...</h3>
            </div>
            
            <div class="home-nav">
                <a href="calendario.html" class="nav-card"><h2>Calendário</h2><p>Agende e visualize os próximos eventos.</p></a>
                <a href="missoes.html" class="nav-card"><h2>Resumo de Missões</h2><p>Tabela com todas as missões e recompensas.</p></a>
                <a href="financas.html" class="nav-card"><h2>Controle Financeiro</h2><p>Planilha de ganhos e gastos da equipe.</p></a>
                <a href="relatorios.html" class="nav-card"><h2>Gerenciar Relatórios</h2><p>Envie e consulte os relatórios dos casos.</p></a>
                <a href="anotacoes.html" class="nav-card"><h2>Anotações Gerais</h2><p>Quadro compartilhado para ideias e pistas.</p></a>
                <a href="social-link.html" class="nav-card"><h2>Relações de Personagens</h2><p>Gerencie a relação entre Personagens</p></a>
            </div>

            <div class="dashboard">
                <div class="dashboard-widget"><h3>Próximos Compromissos</h3><ul id="upcoming-appointments"><li>Carregando...</li></ul></div>
                <div class="dashboard-widget"><h3>Última Missão</h3><p id="latest-mission">Carregando...</p></div>
                <div class="dashboard-widget"><h3>Saldos dos Agentes</h3><ul id="character-balances"><li>Carregando...</li></ul></div>
            </div>
            

            
        </main>

        <section id="character-album-section" class="container">
    <h2>Álbum de Memórias da Akane</h2>
    <p>Momentos marcantes e ilustrações da jornada.</p>

    <div class="photo-grid">
        <img src="./Nia/2025-10-04 15.11.07.jpg" 
             data-full-src="./Nia/2025-10-04 15.11.07.jpg" 
             data-caption="Aqui vai a legenda da primeira imagem. Pode descrever a cena." 
             alt="Descrição da Imagem 1">

        <img src="./Nia/2025-10-04 15.11.25.jpg" 
             data-full-src="./Nia/2025-10-04 15.11.25.jpg" 
             data-caption="Legenda da segunda imagem." 
             alt="Descrição da Imagem 2">

        <img src="./Nia/2025-10-04 15.11.34.jpg" 
             data-full-src="./Nia/2025-10-04 15.11.34.jpg" 
             data-caption="Legenda da terceira imagem." 
             alt="Descrição da Imagem 3">

        <img src="./Nia/Nia ensaio (1).png" 
             data-full-src="./Nia/Nia ensaio (1).png" 
             data-caption="Legenda da quarta imagem." 
             alt="Descrição da Imagem 4">

        <img src="./Nia/Nia ensaio.png" 
            data-full-src="U./Nia/Nia ensaio.png" 
            data-caption="Legenda da quinta imagem." 
            alt="Descrição da Imagem 5">
        
        </div>
</section>

<div id="lightbox-modal" class="lightbox-modal">
    <span class="lightbox-close-button">&times;</span>
    <span class="lightbox-nav lightbox-prev">&#10094;</span>
    <span class="lightbox-nav lightbox-next">&#10095;</span>
    <div class="lightbox-content">
        <img id="lightbox-image" src="" alt="Imagem em tela cheia">
        <div id="lightbox-caption-container">
            <p id="lightbox-counter"></p>
            <p id="lightbox-caption"></p>
        </div>
    </div>
</div>

        <footer class="home-footer">
            <hr style="margin: 40px 0; width: 100%;">
            <img src="cartao-visita.jpg" alt="Cartão de Visita da Agência MIST">
            <p>Para novos casos ou consultas, procure a agência no endereço: <strong>Rua Observador, 42 - Alexandria</strong>.</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const db = firebase.firestore();
        const gameDateRef = db.collection("game_state").doc("current_date"); 
        const appointmentsCollection = db.collection("rpg-appointments");

        const todayInfoContainer = document.getElementById('today-info-container');
        const upcomingAppointmentsList = document.getElementById("upcoming-appointments");
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        gameDateRef.onSnapshot(settingsDoc => {
            let rpgCurrentDate;
            if (settingsDoc.exists) {
                rpgCurrentDate = settingsDoc.data();
            } else {
                const today = new Date();
                rpgCurrentDate = { day: today.getDate(), month: today.getMonth(), year: today.getFullYear() };
            }
            
            // AQUI ESTÁ A CORREÇÃO: Converte o ano para 4 dígitos para uso interno
            const fullYear = (rpgCurrentDate.year < 100) ? rpgCurrentDate.year + 2000 : rpgCurrentDate.year;
            
            const todayInGame = new Date(fullYear, rpgCurrentDate.month, rpgCurrentDate.day);
            todayInGame.setHours(0, 0, 0, 0);

            // AQUI ESTÁ A CORREÇÃO: Usamos o ano original para o formato de string
            const dateStr = `${rpgCurrentDate.year}-${rpgCurrentDate.month + 1}-${rpgCurrentDate.day}`;
            const formattedDate = `${rpgCurrentDate.day} de ${months[rpgCurrentDate.month]} de ${rpgCurrentDate.year}`;
            
            // 1. Atualiza a seção "Hoje no jogo"
            appointmentsCollection.where("dateStr", "==", dateStr).onSnapshot(snapshot => {
                let infoHTML = `<h3>Hoje no jogo é ${formattedDate}</h3>`;
                if (!snapshot.empty) {
                    infoHTML += '<h4>Compromissos do dia:</h4><ul>';
                    snapshot.docs.forEach(doc => {
                        const app = doc.data();
                        infoHTML += `<li>${app.text}</li>`;
                    });
                    infoHTML += '</ul>';
                } else {
                    infoHTML += '<p>Nenhum compromisso agendado para hoje no jogo.</p>';
                }
                todayInfoContainer.innerHTML = infoHTML;
            });

            // 2. Atualiza a seção de "Próximos Compromissos"
            appointmentsCollection.onSnapshot(snapshot => {
                const appointments = [];
                snapshot.docs.forEach(doc => {
                    const app = doc.data();
                    const [year, month, day] = app.dateStr.split("-").map(Number);

                    // AQUI ESTÁ A CORREÇÃO PRINCIPAL: Cria a data completa para comparação
                    const fullAppYear = (year < 100) ? year + 2000 : year;
                    const appDate = new Date(fullAppYear, month - 1, day);

                    if (appDate >= todayInGame) {
                        appointments.push({ date: appDate, text: app.text });
                    }
                });
                appointments.sort((a, b) => a.date - b.date);
                const upcoming = appointments.slice(0, 3);
                upcomingAppointmentsList.innerHTML = "";
                if (upcoming.length === 0) {
                    upcomingAppointmentsList.innerHTML = "<li>Nenhum compromisso futuro.</li>";
                } else {
                    upcoming.forEach(app => {
                        const li = document.createElement("li");
                        li.textContent = `${app.date.toLocaleDateString()}: ${app.text}`;
                        upcomingAppointmentsList.appendChild(li);
                    });
                }
            });
        });

        const latestMissionEl = document.getElementById("latest-mission");
        const missionsCollection = db.collection("missions");
        missionsCollection.orderBy("createdAt", "desc").limit(1).onSnapshot(snapshot => {
            if (snapshot.empty) {
                latestMissionEl.textContent = "Nenhuma missão registrada.";
            } else {
                latestMissionEl.innerHTML = `<span class="mission-title">${snapshot.docs[0].data().name}</span><br><small>${snapshot.docs[0].data().summary.substring(0, 100)}...</small>`;
            }
        });

        const balancesList = document.getElementById("character-balances");
        const financesCollection = db.collection("finances");
        const characters = ["Akane", "Gemini", "Tilas", "Daemian", "Bart"];
        financesCollection.onSnapshot(snapshot => {
            const balances = { Akane: 0, Gemini: 0, Tilas: 0, Daemian: 0, Bart: 0 };
            snapshot.docs.forEach(doc => {
                const finance = doc.data();
                if (balances.hasOwnProperty(finance.character)) {
                    balances[finance.character] += finance.amount;
                }
            });
            balancesList.innerHTML = "";
            characters.forEach(char => {
                const li = document.createElement("li");
                li.className = "balance-item";
                li.innerHTML = `<span>${char}</span> <strong>${balances[char]} zenny</strong>`;
                balancesList.appendChild(li);
            });
        });
    </script>

    <script src="auth-check.js"></script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/agencia-mist/sw.js')
            .then(registration => {
              console.log('Service Worker registrado com sucesso:', registration);
            })
            .catch(error => {
              console.log('Falha ao registrar o Service Worker:', error);
            });
        });
      }

      document.addEventListener('DOMContentLoaded', () => {

            // --- LÓGICA DO ÁLBUM DE FOTOS ---
            const photoGrid = document.querySelector('.photo-grid');
            if (!photoGrid) return; // Se não houver álbum na página, não faz nada

            const images = photoGrid.querySelectorAll('img');
            const modal = document.getElementById('lightbox-modal');
            const modalImage = document.getElementById('lightbox-image');
            const closeBtn = document.querySelector('.lightbox-close-button');
            const prevBtn = document.querySelector('.lightbox-prev');
            const nextBtn = document.querySelector('.lightbox-next');
            const captionEl = document.getElementById('lightbox-caption');
            const counterEl = document.getElementById('lightbox-counter');
            
            let currentIndex;

            // Função para abrir o lightbox
            function openLightbox(index) {
                currentIndex = index;
                const img = images[currentIndex];
                
                modalImage.src = img.dataset.fullSrc;
                captionEl.textContent = img.dataset.caption;
                counterEl.textContent = `Imagem ${currentIndex + 1} de ${images.length}`;
                
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Impede o scroll da página ao fundo
            }

            // Função para fechar o lightbox
            function closeLightbox() {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restaura o scroll
            }

            // Navegação
            function showNextImage() {
                currentIndex = (currentIndex + 1) % images.length;
                openLightbox(currentIndex);
            }

            function showPrevImage() {
                currentIndex = (currentIndex - 1 + images.length) % images.length;
                openLightbox(currentIndex);
            }
            
            // Eventos de clique
            images.forEach((img, index) => {
                img.addEventListener('click', () => {
                    openLightbox(index);
                });
            });

            closeBtn.addEventListener('click', closeLightbox);
            nextBtn.addEventListener('click', showNextImage);
            prevBtn.addEventListener('click', showPrevImage);
            
            // Fecha o modal se clicar fora da imagem
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeLightbox();
                }
            });

            // Navegação pelo teclado (Escape, setas)
            document.addEventListener('keydown', (e) => {
                if (modal.style.display === 'flex') {
                    if (e.key === 'Escape') closeLightbox();
                    if (e.key === 'ArrowRight') showNextImage();
                    if (e.key === 'ArrowLeft') showPrevImage();
                }
            });
        });
    </script>


</body>
</html>
</body>
</html>
