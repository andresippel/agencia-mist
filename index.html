<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agência MIST - Portal da Campanha</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="auth-check.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <style>
        .home-header {
            position: relative;
            text-align: center;
        }
        #auth-status-container {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 0.9em;
            z-index: 10;
        }
        .home-header img { max-width: 150px; margin-bottom: 10px; }
        .home-header h1 { margin-top: 0; }
        .welcome-text { text-align: center; font-size: 1.1em; color: #555; margin-bottom: 40px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-top: 40px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; }
        .dashboard-widget { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); }
        .dashboard-widget h3 { margin-top: 0; color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .dashboard-widget ul { list-style-type: none; padding: 0; margin: 0; }
        .dashboard-widget li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .mission-title { font-weight: bold; }
        .balance-item { display: flex; justify-content: space-between; }
        .home-footer img { max-width: 100%; max-width: 700px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .home-footer p { margin-top: 20px; font-size: 1.1em; color: #333; }

        #today-info-container {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="home-header">
            <div id="auth-status-container"></div>
            <img src="logo.png" alt="Logo da Agência MIST">
            <h1>Portal de Acesso da Agência MIST</h1>
        </header>

        <main>
            <p class="welcome-text">Bem-vindo, Agente. Consulte os arquivos e recursos da MIST (Monitoramento, Investigação e Soluções Táticas) através dos módulos de acesso abaixo.</p>
            
            <div id="today-info-container">
                <h3>Carregando...</h3>
            </div>
            
            <div class="home-nav">
                <a href="calendario.html" class="nav-card"><h2>Calendário</h2><p>Agende e visualize os próximos eventos.</p></a>
                <a href="missoes.html" class="nav-card"><h2>Resumo de Missões</h2><p>Tabela com todas as missões e recompensas.</p></a>
                <a href="financas.html" class="nav-card"><h2>Controle Financeiro</h2><p>Planilha de ganhos e gastos da equipe.</p></a>
                <a href="relatorios.html" class="nav-card"><h2>Gerenciar Relatórios</h2><p>Envie e consulte os relatórios dos casos.</p></a>
                <a href="anotacoes.html" class="nav-card"><h2>Anotações Gerais</h2><p>Quadro compartilhado para ideias e pistas.</p></a>
                <a href="social-links.html" class="nav-card"><h2>Relações de Personagens</h2><p>Gerencie afeição/desgosto entre PCs e NPCs.</p></a>
            </div>

            <div class="dashboard">
                <div class="dashboard-widget"><h3>Próximos Compromissos</h3><ul id="upcoming-appointments"><li>Carregando...</li></ul></div>
                <div class="dashboard-widget"><h3>Última Missão</h3><p id="latest-mission">Carregando...</p></div>
                <div class="dashboard-widget"><h3>Saldos dos Agentes</h3><ul id="character-balances"><li>Carregando...</li></ul></div>
            </div>
        </main>

        <footer class="home-footer">
            <hr style="margin: 40px 0;">
            <img src="cartao-visita.jpg" alt="Cartão de Visita da Agência MIST">
            <p>Para novos casos ou consultas, procure a agência no endereço: <strong>Rua Observador, 42 - Alexandria</strong>.</p>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const db = firebase.firestore();
        const gameDateRef = db.collection("game_state").doc("current_date"); 
        const appointmentsCollection = db.collection("rpg-appointments");

        const todayInfoContainer = document.getElementById('today-info-container');
        const upcomingAppointmentsList = document.getElementById("upcoming-appointments");
        const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        gameDateRef.onSnapshot(settingsDoc => {
            let rpgCurrentDate;
            if (settingsDoc.exists) {
                rpgCurrentDate = settingsDoc.data();
            } else {
                const today = new Date();
                rpgCurrentDate = { day: today.getDate(), month: today.getMonth(), year: today.getFullYear() };
            }
            
            const fullYear = (rpgCurrentDate.year < 100) ? rpgCurrentDate.year + 2000 : rpgCurrentDate.year;
            
            const todayInGame = new Date(fullYear, rpgCurrentDate.month, rpgCurrentDate.day);
            todayInGame.setHours(0, 0, 0, 0);

            const dateStr = `${fullYear}-${todayInGame.getMonth() + 1}-${todayInGame.getDate()}`;
            
            // AQUI ESTÁ A ÚNICA MUDANÇA: usa o ano original (rpgCurrentDate.year) para a exibição
            const formattedDate = `${rpgCurrentDate.day} de ${months[rpgCurrentDate.month]} de ${rpgCurrentDate.year}`;
            
            appointmentsCollection.where("dateStr", "==", dateStr).onSnapshot(snapshot => {
                let infoHTML = `<h3>Hoje no jogo é ${formattedDate}</h3>`;
                if (!snapshot.empty) {
                    infoHTML += '<h4>Compromissos do dia:</h4><ul>';
                    snapshot.docs.forEach(doc => {
                        const app = doc.data();
                        infoHTML += `<li>${app.text}</li>`;
                    });
                    infoHTML += '</ul>';
                } else {
                    infoHTML += '<p>Nenhum compromisso agendado para hoje no jogo.</p>';
                }
                todayInfoContainer.innerHTML = infoHTML;
            });

            appointmentsCollection.onSnapshot(snapshot => {
                const appointments = [];
                snapshot.docs.forEach(doc => {
                    const app = doc.data();
                    const [year, month, day] = app.dateStr.split("-").map(Number);
                    const appDate = new Date(year, month - 1, day);
                    if (appDate >= todayInGame) {
                        appointments.push({ date: appDate, text: app.text });
                    }
                });
                appointments.sort((a, b) => a.date - b.date);
                const upcoming = appointments.slice(0, 3);
                upcomingAppointmentsList.innerHTML = "";
                if (upcoming.length === 0) {
                    upcomingAppointmentsList.innerHTML = "<li>Nenhum compromisso futuro.</li>";
                } else {
                    upcoming.forEach(app => {
                        const li = document.createElement("li");
                        li.textContent = `${app.date.toLocaleDateString()}: ${app.text}`;
                        upcomingAppointmentsList.appendChild(li);
                    });
                }
            });
        });

        const latestMissionEl = document.getElementById("latest-mission");
        const missionsCollection = db.collection("missions");
        missionsCollection.orderBy("createdAt", "desc").limit(1).onSnapshot(snapshot => {
            if (snapshot.empty) {
                latestMissionEl.textContent = "Nenhuma missão registrada.";
            } else {
                latestMissionEl.innerHTML = `<span class="mission-title">${snapshot.docs[0].data().name}</span><br><small>${snapshot.docs[0].data().summary.substring(0, 100)}...</small>`;
            }
        });

        const balancesList = document.getElementById("character-balances");
        const financesCollection = db.collection("finances");
        const characters = ["Akane", "Gemini", "Tilas", "Daemian", "Bart"];
        financesCollection.onSnapshot(snapshot => {
            const balances = { Akane: 0, Gemini: 0, Tilas: 0, Daemian: 0, Bart: 0 };
            snapshot.docs.forEach(doc => {
                const finance = doc.data();
                if (balances.hasOwnProperty(finance.character)) {
                    balances[finance.character] += finance.amount;
                }
            });
            balancesList.innerHTML = "";
            characters.forEach(char => {
                const li = document.createElement("li");
                li.className = "balance-item";
                li.innerHTML = `<span>${char}</span> <strong>${balances[char]} zenny</strong>`;
                balancesList.appendChild(li);
            });
        });
    </script>
</body>
</html>